##############################
# THIS FILE IS AUTOGENERATED #
#    DO NOT MANUALLY EDIT    #
##############################
name: '[flowey] OpenVMM PR'
on:
  workflow_dispatch:
    inputs:
      verbose:
        description: Run with verbose output
        default: false
        required: false
        type: boolean
  pull_request:
    branches:
    - main
    - release/*
    types:
    - opened
    - synchronize
    - reopened
    - ready_for_review
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true
jobs:
  job0:
    name: build mdbook guide
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 0 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 0 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 0 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/guide"
        echo "$AgentTempDirNormal/publish_artifacts/guide" | flowey v 0 'artifact_publish_from_guide' --update-from-stdin --is-raw-string
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 0 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 0 flowey_lib_common::cache 0
        flowey v 0 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey v 0 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 0 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 0 flowey_lib_common::cache 2
        flowey e 0 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 0 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 0 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: unpack mdbook
      run: flowey e 0 flowey_lib_common::download_mdbook 0
      shell: bash
    - name: unpack mdbook-admonish
      run: flowey e 0 flowey_lib_common::download_mdbook_admonish 0
      shell: bash
    - name: unpack mdbook-mermaid
      run: flowey e 0 flowey_lib_common::download_mdbook_mermaid 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 0 flowey_lib_common::git_checkout 0
        flowey v 0 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 0 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 0 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 0 flowey_lib_common::git_checkout 3
        flowey e 0 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey e 0 flowey_lib_hvlite::build_guide 0
      shell: bash
    - name: add default cargo home to path
      run: flowey e 0 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 0 flowey_lib_common::install_rust 1
      shell: bash
    - name: build OpenVMM guide (mdbook)
      run: |-
        flowey e 0 flowey_lib_hvlite::build_guide 1
        flowey e 0 flowey_lib_hvlite::artifact_guide::publish 0
      shell: bash
    - name: copying guide to artifact dir
      run: flowey e 0 flowey_lib_common::copy_to_artifact_dir 0
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 0 flowey_lib_common::cache 3
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish guide
      uses: actions/upload-artifact@v4
      with:
        name: guide
        path: ${{ runner.temp }}/publish_artifacts/guide/
  job1:
    name: build and check docs [x64-windows]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Win-Pool-WestUS3
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 1 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 1 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 1 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-rustdoc"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-rustdoc" | flowey.exe v 1 'artifact_publish_from_x64-windows-rustdoc' --update-from-stdin --is-raw-string
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 1 flowey_lib_common::git_checkout 0
        flowey.exe v 1 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 1 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar3 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 1 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 1 flowey_lib_common::git_checkout 3
        flowey.exe e 1 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey.exe e 1 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 1 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 1 flowey_lib_common::cache 0
        flowey.exe v 1 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar1 --is-raw-string
        flowey.exe v 1 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar2 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar1 }}
        path: ${{ env.floweyvar2 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 1 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 1 flowey_lib_common::cache 2
        flowey.exe e 1 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack protoc
      run: |-
        flowey.exe e 1 flowey_lib_common::download_protoc 0
        flowey.exe e 1 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: flowey.exe e 1 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
      shell: bash
    - name: add default cargo home to path
      run: flowey.exe e 1 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 1 flowey_lib_common::install_rust 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.x64.zip
      run: flowey.exe e 1 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey.exe e 1 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey.exe e 1 flowey_lib_common::install_rust 2
        flowey.exe e 1 flowey_lib_common::cfg_cargo_common_flags 0
        flowey.exe e 1 flowey_lib_common::run_cargo_doc 0
      shell: bash
    - name: document repo for target x86_64-pc-windows-msvc
      run: flowey.exe e 1 flowey_lib_hvlite::build_rustdoc 0
      shell: bash
    - name: archive rustdoc dir
      run: |-
        flowey.exe e 1 flowey_lib_hvlite::artifact_rustdoc::publish 0
        flowey.exe e 1 flowey_lib_hvlite::artifact_rustdoc::publish 1
      shell: bash
    - name: copying rustdoc to artifact dir
      run: flowey.exe e 1 flowey_lib_common::copy_to_artifact_dir 0
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 1 flowey_lib_common::cache 3
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-rustdoc
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-rustdoc
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-rustdoc/
  job10:
    name: build artifacts [x64-linux]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 10 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 10 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 10 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-guest_test_uefi"
        echo "$AgentTempDirNormal/publish_artifacts/x64-guest_test_uefi" | flowey v 10 'artifact_publish_from_x64-guest_test_uefi' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-igvmfilegen"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-igvmfilegen" | flowey v 10 'artifact_publish_from_x64-linux-igvmfilegen' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-ohcldiag-dev"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-ohcldiag-dev" | flowey v 10 'artifact_publish_from_x64-linux-ohcldiag-dev' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-openvmm"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-openvmm" | flowey v 10 'artifact_publish_from_x64-linux-openvmm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-vmgs_lib"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-vmgs_lib" | flowey v 10 'artifact_publish_from_x64-linux-vmgs_lib' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-vmgstool"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-vmgstool" | flowey v 10 'artifact_publish_from_x64-linux-vmgstool' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-vmm-tests-archive"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-vmm-tests-archive" | flowey v 10 'artifact_publish_from_x64-linux-vmm-tests-archive' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-tmks"
        echo "$AgentTempDirNormal/publish_artifacts/x64-tmks" | flowey v 10 'artifact_publish_from_x64-tmks' --update-from-stdin --is-raw-string
      shell: bash
    - name: add default cargo home to path
      run: flowey e 10 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 10 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 10 flowey_lib_common::install_rust 2
        flowey e 10 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 10 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 10 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 10 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 10 flowey_lib_common::cache 4
        flowey v 10 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar4 --is-raw-string
        flowey v 10 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar5 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar4 }}
        path: ${{ env.floweyvar5 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 10 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey e 10 flowey_lib_common::cache 6
        flowey e 10 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.x64.zip
      run: flowey e 10 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 10 flowey_lib_common::git_checkout 0
        flowey v 10 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 10 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 10 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 10 flowey_lib_common::git_checkout 3
        flowey e 10 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey e 10 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey e 10 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 10 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: flowey e 10 flowey_lib_common::download_protoc 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey e 10 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey e 10 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build openvmm
      run: |-
        flowey e 10 flowey_lib_common::run_cargo_build 3
        flowey e 10 flowey_lib_hvlite::run_cargo_build 5
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 10 flowey_lib_hvlite::run_split_debug_info 1
        flowey e 10 flowey_lib_hvlite::run_cargo_build 6
        flowey e 10 flowey_lib_hvlite::build_openvmm 0
        flowey e 10 flowey_core::pipeline::artifact::publish 0
        flowey e 10 flowey_lib_hvlite::init_cross_build 5
      shell: bash
    - name: cargo build vmgstool
      run: |-
        flowey e 10 flowey_lib_common::run_cargo_build 6
        flowey e 10 flowey_lib_hvlite::run_cargo_build 12
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 10 flowey_lib_hvlite::run_split_debug_info 3
        flowey e 10 flowey_lib_hvlite::run_cargo_build 13
        flowey e 10 flowey_lib_hvlite::build_vmgstool 0
        flowey e 10 flowey_core::pipeline::artifact::publish 1
        flowey e 10 flowey_lib_hvlite::init_cross_build 4
      shell: bash
    - name: cargo build vmgs_lib
      run: |-
        flowey e 10 flowey_lib_common::run_cargo_build 5
        flowey e 10 flowey_lib_hvlite::run_cargo_build 11
        flowey e 10 flowey_lib_hvlite::build_and_test_vmgs_lib 0
      shell: bash
    - name: test vmgs_lib
      run: |-
        flowey e 10 flowey_lib_hvlite::build_and_test_vmgs_lib 1
        flowey e 10 flowey_lib_hvlite::build_and_test_vmgs_lib 2
        flowey e 10 flowey_core::pipeline::artifact::publish 2
        flowey e 10 flowey_lib_hvlite::init_cross_build 6
      shell: bash
    - name: cargo build igvmfilegen
      run: |-
        flowey e 10 flowey_lib_common::run_cargo_build 1
        flowey e 10 flowey_lib_hvlite::run_cargo_build 1
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 10 flowey_lib_hvlite::run_split_debug_info 4
        flowey e 10 flowey_lib_hvlite::run_cargo_build 2
        flowey e 10 flowey_lib_hvlite::build_igvmfilegen 0
        flowey e 10 flowey_core::pipeline::artifact::publish 3
        flowey e 10 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build ohcldiag-dev
      run: |-
        flowey e 10 flowey_lib_common::run_cargo_build 2
        flowey e 10 flowey_lib_hvlite::run_cargo_build 3
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 10 flowey_lib_hvlite::run_split_debug_info 0
        flowey e 10 flowey_lib_hvlite::run_cargo_build 4
        flowey e 10 flowey_lib_hvlite::build_ohcldiag_dev 0
        flowey e 10 flowey_core::pipeline::artifact::publish 4
        flowey e 10 flowey_lib_hvlite::init_cross_build 7
      shell: bash
    - name: cargo build guest_test_uefi
      run: |-
        flowey e 10 flowey_lib_common::run_cargo_build 0
        flowey e 10 flowey_lib_hvlite::run_cargo_build 0
      shell: bash
    - name: build guest_test_uefi.img
      run: |-
        flowey e 10 flowey_lib_hvlite::build_guest_test_uefi 0
        flowey e 10 flowey_core::pipeline::artifact::publish 5
        flowey e 10 flowey_lib_hvlite::init_cross_build 0
        flowey e 10 flowey_lib_hvlite::run_cargo_build 7
        flowey e 10 flowey_lib_hvlite::run_cargo_build 8
      shell: bash
    - name: cargo build simple_tmk
      run: |-
        flowey e 10 flowey_lib_common::run_cargo_build 4
        flowey e 10 flowey_lib_hvlite::run_cargo_build 9
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 10 flowey_lib_hvlite::run_split_debug_info 2
        flowey e 10 flowey_lib_hvlite::run_cargo_build 10
        flowey e 10 flowey_lib_hvlite::build_tmks 0
        flowey e 10 flowey_core::pipeline::artifact::publish 6
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey e 10 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 10 flowey_lib_common::cache 0
        flowey v 10 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey v 10 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: cargo-nextest'
    - name: report $CARGO_HOME
      run: |-
        flowey v 10 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 10 flowey_lib_common::cache 2
        flowey e 10 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey e 10 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: |-
        flowey e 10 flowey_lib_common::download_cargo_nextest 1
        flowey e 10 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: build + archive 'vmm_tests' nextests
      run: |-
        flowey e 10 flowey_lib_common::run_cargo_nextest_archive 0
        flowey e 10 flowey_lib_hvlite::build_nextest_vmm_tests 0
        flowey e 10 flowey_core::pipeline::artifact::publish 7
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey e 10 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 10 flowey_lib_common::cache 7
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish x64-guest_test_uefi
      uses: actions/upload-artifact@v4
      with:
        name: x64-guest_test_uefi
        path: ${{ runner.temp }}/publish_artifacts/x64-guest_test_uefi/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-igvmfilegen
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-igvmfilegen
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-igvmfilegen/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-ohcldiag-dev
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-ohcldiag-dev
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-ohcldiag-dev/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-openvmm
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-openvmm
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-openvmm/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-vmgs_lib
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-vmgs_lib
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-vmgs_lib/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-vmgstool
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-vmgstool
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-vmgstool/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-vmm-tests-archive
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-vmm-tests-archive
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-vmm-tests-archive/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-tmks
      uses: actions/upload-artifact@v4
      with:
        name: x64-tmks
        path: ${{ runner.temp }}/publish_artifacts/x64-tmks/
  job11:
    name: build openhcl [aarch64-linux]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 11 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 11 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 11 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-linux-musl-pipette"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-linux-musl-pipette" | flowey v 11 'artifact_publish_from_aarch64-linux-musl-pipette' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-linux-musl-tmk_vmm"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-linux-musl-tmk_vmm" | flowey v 11 'artifact_publish_from_aarch64-linux-musl-tmk_vmm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-openhcl-igvm"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-openhcl-igvm" | flowey v 11 'artifact_publish_from_aarch64-openhcl-igvm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-openhcl-igvm-extras"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-openhcl-igvm-extras" | flowey v 11 'artifact_publish_from_aarch64-openhcl-igvm-extras' --update-from-stdin --is-raw-string
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 11 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 11 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 11 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 11 flowey_lib_common::cache 0
        flowey v 11 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar1 --is-raw-string
        flowey v 11 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar2 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar1 }}
        path: ${{ env.floweyvar2 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 11 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 11 flowey_lib_common::cache 2
        flowey e 11 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack mu_msvm package (aarch64)
      run: flowey e 11 flowey_lib_hvlite::download_uefi_mu_msvm 0
      shell: bash
    - name: add default cargo home to path
      run: flowey e 11 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 11 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 11 flowey_lib_common::install_rust 2
        flowey e 11 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 11 flowey_lib_common::git_checkout 0
        flowey v 11 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 11 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar3 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 11 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 11 flowey_lib_common::git_checkout 3
        flowey e 11 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 11 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: |-
        flowey e 11 flowey_lib_common::download_protoc 0
        flowey e 11 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey e 11 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey e 11 flowey_lib_hvlite::init_cross_build 0
        flowey e 11 flowey_lib_hvlite::run_cargo_build 2
        flowey e 11 flowey_lib_hvlite::run_cargo_build 3
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey e 11 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: extract Aarch64 sysroot.tar.gz
      run: flowey e 11 flowey_lib_hvlite::init_openvmm_magicpath_openhcl_sysroot 0
      shell: bash
    - name: cargo build openhcl_boot
      run: |-
        flowey e 11 flowey_lib_common::run_cargo_build 1
        flowey e 11 flowey_lib_hvlite::run_cargo_build 4
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 11 flowey_lib_hvlite::run_split_debug_info 2
        flowey e 11 flowey_lib_hvlite::run_cargo_build 5
        flowey e 11 flowey_lib_hvlite::build_openhcl_boot 0
      shell: bash
    - name: unpack kernel package
      run: |-
        flowey e 11 flowey_lib_hvlite::download_openhcl_kernel_package 1
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 18
        flowey e 11 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build openvmm_hcl
      run: |-
        flowey e 11 flowey_lib_common::run_cargo_build 2
        flowey e 11 flowey_lib_hvlite::run_cargo_build 6
        flowey e 11 flowey_lib_hvlite::build_openvmm_hcl 0
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 14
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 11 flowey_lib_hvlite::run_split_debug_info 1
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 15
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 16
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 19
      shell: bash
    - name: building openhcl initrd
      run: |-
        flowey e 11 flowey_lib_hvlite::build_openhcl_initrd 1
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 20
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 21
        flowey e 11 flowey_lib_hvlite::init_cross_build 4
      shell: bash
    - name: cargo build igvmfilegen
      run: |-
        flowey e 11 flowey_lib_common::run_cargo_build 0
        flowey e 11 flowey_lib_hvlite::run_cargo_build 0
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 11 flowey_lib_hvlite::run_split_debug_info 5
        flowey e 11 flowey_lib_hvlite::run_cargo_build 1
        flowey e 11 flowey_lib_hvlite::build_igvmfilegen 0
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 22
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 23
      shell: bash
    - name: building igvm file
      run: |-
        flowey e 11 flowey_lib_hvlite::run_igvmfilegen 1
        flowey e 11 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 2
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 6
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 2
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 11 flowey_lib_hvlite::run_split_debug_info 0
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 3
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 4
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 7
      shell: bash
    - name: unpack kernel package
      run: flowey e 11 flowey_lib_hvlite::download_openhcl_kernel_package 0
      shell: bash
    - name: building openhcl initrd
      run: |-
        flowey e 11 flowey_lib_hvlite::build_openhcl_initrd 0
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 8
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 9
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 10
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 11
      shell: bash
    - name: building igvm file
      run: |-
        flowey e 11 flowey_lib_hvlite::run_igvmfilegen 0
        flowey e 11 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 0
        flowey e 11 flowey_lib_hvlite::artifact_openhcl_igvm_from_recipe::publish 0
      shell: bash
    - name: copying OpenHCL igvm files to artifact dir
      run: |-
        flowey e 11 flowey_lib_common::copy_to_artifact_dir 1
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 12
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 17
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 13
        flowey e 11 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 3
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 5
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 1
        flowey e 11 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 0
        flowey e 11 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 1
        flowey e 11 flowey_lib_hvlite::artifact_openhcl_igvm_from_recipe_extras::publish 0
      shell: bash
    - name: copying OpenHCL igvm extras to artifact dir
      run: |-
        flowey e 11 flowey_lib_common::copy_to_artifact_dir 0
        flowey e 11 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build pipette
      run: |-
        flowey e 11 flowey_lib_common::run_cargo_build 3
        flowey e 11 flowey_lib_hvlite::run_cargo_build 7
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 11 flowey_lib_hvlite::run_split_debug_info 3
        flowey e 11 flowey_lib_hvlite::run_cargo_build 8
        flowey e 11 flowey_lib_hvlite::build_pipette 0
        flowey e 11 flowey_core::pipeline::artifact::publish 0
        flowey e 11 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build tmk_vmm
      run: |-
        flowey e 11 flowey_lib_common::run_cargo_build 4
        flowey e 11 flowey_lib_hvlite::run_cargo_build 9
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 11 flowey_lib_hvlite::run_split_debug_info 4
        flowey e 11 flowey_lib_hvlite::run_cargo_build 10
        flowey e 11 flowey_lib_hvlite::build_tmk_vmm 0
        flowey e 11 flowey_core::pipeline::artifact::publish 1
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 11 flowey_lib_common::cache 3
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-linux-musl-pipette
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-linux-musl-pipette
        path: ${{ runner.temp }}/publish_artifacts/aarch64-linux-musl-pipette/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-linux-musl-tmk_vmm
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-linux-musl-tmk_vmm
        path: ${{ runner.temp }}/publish_artifacts/aarch64-linux-musl-tmk_vmm/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-openhcl-igvm
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-openhcl-igvm
        path: ${{ runner.temp }}/publish_artifacts/aarch64-openhcl-igvm/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-openhcl-igvm-extras
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-openhcl-igvm-extras
        path: ${{ runner.temp }}/publish_artifacts/aarch64-openhcl-igvm-extras/
  job12:
    name: build openhcl [x64-linux]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 12 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 12 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 12 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-musl-pipette"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-musl-pipette" | flowey v 12 'artifact_publish_from_x64-linux-musl-pipette' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-musl-tmk_vmm"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-musl-tmk_vmm" | flowey v 12 'artifact_publish_from_x64-linux-musl-tmk_vmm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-openhcl-igvm"
        echo "$AgentTempDirNormal/publish_artifacts/x64-openhcl-igvm" | flowey v 12 'artifact_publish_from_x64-openhcl-igvm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-openhcl-igvm-extras"
        echo "$AgentTempDirNormal/publish_artifacts/x64-openhcl-igvm-extras" | flowey v 12 'artifact_publish_from_x64-openhcl-igvm-extras' --update-from-stdin --is-raw-string
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 12 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 12 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 12 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 12 flowey_lib_common::cache 0
        flowey v 12 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar1 --is-raw-string
        flowey v 12 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar2 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar1 }}
        path: ${{ env.floweyvar2 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 12 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 12 flowey_lib_common::cache 2
        flowey e 12 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack mu_msvm package (x64)
      run: flowey e 12 flowey_lib_hvlite::download_uefi_mu_msvm 0
      shell: bash
    - name: add default cargo home to path
      run: flowey e 12 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 12 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 12 flowey_lib_common::install_rust 2
        flowey e 12 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 12 flowey_lib_common::git_checkout 0
        flowey v 12 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 12 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar3 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 12 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 12 flowey_lib_common::git_checkout 3
        flowey e 12 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 12 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: |-
        flowey e 12 flowey_lib_common::download_protoc 0
        flowey e 12 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey e 12 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey e 12 flowey_lib_hvlite::init_cross_build 4
        flowey e 12 flowey_lib_hvlite::run_cargo_build 9
        flowey e 12 flowey_lib_hvlite::run_cargo_build 10
      shell: bash
    - name: cargo build sidecar
      run: |-
        flowey e 12 flowey_lib_common::run_cargo_build 4
        flowey e 12 flowey_lib_hvlite::run_cargo_build 11
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 7
        flowey e 12 flowey_lib_hvlite::run_cargo_build 12
        flowey e 12 flowey_lib_hvlite::build_sidecar 0
        flowey e 12 flowey_lib_hvlite::init_cross_build 5
        flowey e 12 flowey_lib_hvlite::run_cargo_build 2
        flowey e 12 flowey_lib_hvlite::run_cargo_build 3
      shell: bash
    - name: cargo build openhcl_boot
      run: |-
        flowey e 12 flowey_lib_common::run_cargo_build 1
        flowey e 12 flowey_lib_hvlite::run_cargo_build 4
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 5
        flowey e 12 flowey_lib_hvlite::run_cargo_build 5
        flowey e 12 flowey_lib_hvlite::build_openhcl_boot 0
      shell: bash
    - name: unpack kernel package
      run: |-
        flowey e 12 flowey_lib_hvlite::download_openhcl_kernel_package 2
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 30
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey e 12 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: extract X64 sysroot.tar.gz
      run: |-
        flowey e 12 flowey_lib_hvlite::init_openvmm_magicpath_openhcl_sysroot 0
        flowey e 12 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build openvmm_hcl
      run: |-
        flowey e 12 flowey_lib_common::run_cargo_build 2
        flowey e 12 flowey_lib_hvlite::run_cargo_build 6
        flowey e 12 flowey_lib_hvlite::build_openvmm_hcl 0
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 26
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 3
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 27
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 28
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 31
      shell: bash
    - name: building openhcl initrd
      run: |-
        flowey e 12 flowey_lib_hvlite::build_openhcl_initrd 4
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 32
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 33
        flowey e 12 flowey_lib_hvlite::init_cross_build 0
      shell: bash
    - name: cargo build igvmfilegen
      run: |-
        flowey e 12 flowey_lib_common::run_cargo_build 0
        flowey e 12 flowey_lib_hvlite::run_cargo_build 0
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 9
        flowey e 12 flowey_lib_hvlite::run_cargo_build 1
        flowey e 12 flowey_lib_hvlite::build_igvmfilegen 0
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 34
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 35
      shell: bash
    - name: building igvm file
      run: |-
        flowey e 12 flowey_lib_hvlite::run_igvmfilegen 4
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 2
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 42
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 38
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 4
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 39
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 40
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 43
      shell: bash
    - name: unpack kernel package
      run: flowey e 12 flowey_lib_hvlite::download_openhcl_kernel_package 0
      shell: bash
    - name: building openhcl initrd
      run: |-
        flowey e 12 flowey_lib_hvlite::build_openhcl_initrd 0
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 44
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 45
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 46
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 47
      shell: bash
    - name: building igvm file
      run: |-
        flowey e 12 flowey_lib_hvlite::run_igvmfilegen 0
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 4
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 54
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 50
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 1
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 51
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 52
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 55
      shell: bash
    - name: building openhcl initrd
      run: |-
        flowey e 12 flowey_lib_hvlite::build_openhcl_initrd 1
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 56
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 57
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 58
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 59
      shell: bash
    - name: building igvm file
      run: |-
        flowey e 12 flowey_lib_hvlite::run_igvmfilegen 1
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 6
      shell: bash
    - name: unpack kernel package
      run: |-
        flowey e 12 flowey_lib_hvlite::download_openhcl_kernel_package 1
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 18
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 14
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 2
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 15
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 16
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 19
      shell: bash
    - name: building openhcl initrd
      run: |-
        flowey e 12 flowey_lib_hvlite::build_openhcl_initrd 3
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 20
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 21
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 22
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 23
      shell: bash
    - name: building igvm file
      run: |-
        flowey e 12 flowey_lib_hvlite::run_igvmfilegen 3
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 8
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 6
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 2
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 0
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 3
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 4
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 7
      shell: bash
    - name: building openhcl initrd
      run: |-
        flowey e 12 flowey_lib_hvlite::build_openhcl_initrd 2
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 8
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 9
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 10
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 11
      shell: bash
    - name: building igvm file
      run: |-
        flowey e 12 flowey_lib_hvlite::run_igvmfilegen 2
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 0
        flowey e 12 flowey_lib_hvlite::artifact_openhcl_igvm_from_recipe::publish 0
      shell: bash
    - name: copying OpenHCL igvm files to artifact dir
      run: |-
        flowey e 12 flowey_lib_common::copy_to_artifact_dir 1
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 24
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 29
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 25
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 3
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 41
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 37
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 36
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 5
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 53
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 49
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 48
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 7
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 17
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 13
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 12
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 9
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 5
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 1
        flowey e 12 flowey_lib_hvlite::build_openhcl_igvm_from_recipe 0
        flowey e 12 flowey_lib_hvlite::_jobs::build_and_publish_openhcl_igvm_from_recipe 1
        flowey e 12 flowey_lib_hvlite::artifact_openhcl_igvm_from_recipe_extras::publish 0
      shell: bash
    - name: copying OpenHCL igvm extras to artifact dir
      run: |-
        flowey e 12 flowey_lib_common::copy_to_artifact_dir 0
        flowey e 12 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build pipette
      run: |-
        flowey e 12 flowey_lib_common::run_cargo_build 3
        flowey e 12 flowey_lib_hvlite::run_cargo_build 7
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 6
        flowey e 12 flowey_lib_hvlite::run_cargo_build 8
        flowey e 12 flowey_lib_hvlite::build_pipette 0
        flowey e 12 flowey_core::pipeline::artifact::publish 0
        flowey e 12 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build tmk_vmm
      run: |-
        flowey e 12 flowey_lib_common::run_cargo_build 5
        flowey e 12 flowey_lib_hvlite::run_cargo_build 13
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 12 flowey_lib_hvlite::run_split_debug_info 8
        flowey e 12 flowey_lib_hvlite::run_cargo_build 14
        flowey e 12 flowey_lib_hvlite::build_tmk_vmm 0
        flowey e 12 flowey_core::pipeline::artifact::publish 1
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 12 flowey_lib_common::cache 3
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-musl-pipette
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-musl-pipette
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-musl-pipette/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-musl-tmk_vmm
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-musl-tmk_vmm
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-musl-tmk_vmm/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-openhcl-igvm
      uses: actions/upload-artifact@v4
      with:
        name: x64-openhcl-igvm
        path: ${{ runner.temp }}/publish_artifacts/x64-openhcl-igvm/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-openhcl-igvm-extras
      uses: actions/upload-artifact@v4
      with:
        name: x64-openhcl-igvm-extras
        path: ${{ runner.temp }}/publish_artifacts/x64-openhcl-igvm-extras/
    - name: ðŸŒ¼ðŸ§¼ Redact bootstrap var db
      run: rm $AgentTempDirNormal/bootstrapped-flowey/job12.json
      shell: bash
    - name: ðŸŒ¼ðŸ¥¾ Publish bootstrapped flowey
      uses: actions/upload-artifact@v4
      with:
        name: _internal-flowey-bootstrap-x86_64-linux-uid-7
        path: ${{ runner.temp }}/bootstrapped-flowey
  job13:
    name: verify openhcl binary size [x64]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 13 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 13 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 13 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: add default cargo home to path
      run: flowey e 13 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 13 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 13 flowey_lib_common::install_rust 2
        flowey e 13 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 13 flowey_lib_common::git_checkout 0
        flowey v 13 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar2 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 13 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar2 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 13 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 13 flowey_lib_common::git_checkout 3
        flowey e 13 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey e 13 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 13 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 13 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 13 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 13 flowey_lib_common::cache 4
        flowey v 13 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar5 --is-raw-string
        flowey v 13 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar6 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar5 }}
        path: ${{ env.floweyvar6 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 13 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey e 13 flowey_lib_common::cache 6
        flowey e 13 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey e 13 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: extract X64 sysroot.tar.gz
      run: flowey e 13 flowey_lib_hvlite::init_openvmm_magicpath_openhcl_sysroot 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 13 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: flowey e 13 flowey_lib_common::download_protoc 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey e 13 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey e 13 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build openvmm_hcl
      run: |-
        flowey e 13 flowey_lib_common::run_cargo_build 0
        flowey e 13 flowey_lib_hvlite::run_cargo_build 0
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 13 flowey_lib_hvlite::run_split_debug_info 1
        flowey e 13 flowey_lib_hvlite::run_cargo_build 1
        flowey e 13 flowey_lib_hvlite::build_openvmm_hcl 0
      shell: bash
    - name: collect openvmm_hcl files for analysis
      run: |-
        flowey e 13 flowey_lib_hvlite::_jobs::check_openvmm_hcl_size 2
        flowey v 13 'flowey_lib_hvlite::_jobs::check_openvmm_hcl_size:9:flowey_core/src/node.rs:1054:34' --write-to-gh-env floweyvar1 --is-raw-string
      shell: bash
    - id: flowey_lib_hvlite___jobs__check_openvmm_hcl_size__3
      uses: actions/upload-artifact@v4
      with:
        name: x86_64_openvmm_hcl_for_size_analysis
        path: ${{ env.floweyvar1 }}
      name: publish openvmm_hcl for analysis
    - name: cargo build xtask
      run: |-
        flowey e 13 flowey_lib_hvlite::init_cross_build 0
        flowey e 13 flowey_lib_common::run_cargo_build 1
        flowey e 13 flowey_lib_hvlite::run_cargo_build 2
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 13 flowey_lib_hvlite::run_split_debug_info 0
        flowey e 13 flowey_lib_hvlite::run_cargo_build 3
        flowey e 13 flowey_lib_hvlite::build_xtask 0
      shell: bash
    - name: create gh cache dir
      run: flowey e 13 flowey_lib_common::download_gh_cli 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 13 flowey_lib_common::cache 0
        flowey v 13 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar3 --is-raw-string
        flowey v 13 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar4 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar3 }}
        path: ${{ env.floweyvar4 }}
      name: 'Restore cache: gh-cli'
    - name: installing gh
      run: |-
        flowey v 13 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 13 flowey_lib_common::cache 2
        flowey e 13 flowey_lib_common::download_gh_cli 1
        flowey v 13 'flowey_lib_hvlite::_jobs::check_openvmm_hcl_size:2:flowey_core/src/node/github_context.rs:42:41' --is-secret --update-from-stdin --is-raw-string <<EOF
        ${{ github.token }}
        EOF
      shell: bash
    - name: setup gh cli
      run: flowey e 13 flowey_lib_common::use_gh_cli 0
      shell: bash
    - name: get merge commit
      run: flowey e 13 flowey_lib_common::git_merge_commit 0
      shell: bash
    - name: get action id
      run: |-
        flowey e 13 flowey_lib_common::gh_workflow_id 0
        flowey e 13 flowey_lib_hvlite::_jobs::check_openvmm_hcl_size 1
      shell: bash
    - name: download artifacts from github actions run
      run: flowey e 13 flowey_lib_common::download_gh_artifact 0
      shell: bash
    - name: binary size comparison
      run: flowey e 13 flowey_lib_hvlite::_jobs::check_openvmm_hcl_size 4
      shell: bash
    - name: 'validate cache entry: gh-cli'
      run: flowey e 13 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 13 flowey_lib_common::cache 7
      shell: bash
  job14:
    name: clippy [windows], unit tests [x64-windows]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Win-Pool-WestUS3
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 14 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 14 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 14 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: add default cargo home to path
      run: flowey.exe e 14 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 14 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey.exe e 14 flowey_lib_common::install_rust 2
        flowey.exe e 14 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 14 flowey_lib_common::git_checkout 0
        flowey.exe v 14 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar6 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 14 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar6 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 14 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 14 flowey_lib_common::git_checkout 3
        flowey.exe e 14 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey.exe e 14 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 14 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 14 flowey_lib_common::cache 4
        flowey.exe v 14 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar4 --is-raw-string
        flowey.exe v 14 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar5 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar4 }}
        path: ${{ env.floweyvar5 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 14 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey.exe e 14 flowey_lib_common::cache 6
        flowey.exe e 14 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack protoc
      run: |-
        flowey.exe e 14 flowey_lib_common::download_protoc 0
        flowey.exe e 14 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey.exe e 14 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey.exe e 14 flowey_lib_hvlite::init_cross_build 1
        flowey.exe e 14 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey.exe e 14 flowey_lib_common::run_cargo_build 0
        flowey.exe e 14 flowey_lib_hvlite::run_cargo_build 0
        flowey.exe e 14 flowey_lib_hvlite::build_xtask 0
      shell: bash
    - name: determine clippy exclusions
      run: flowey.exe e 14 flowey_lib_hvlite::_jobs::check_clippy 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.x64.zip
      run: flowey.exe e 14 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.AARCH64.zip
      run: flowey.exe e 14 flowey_lib_hvlite::download_lxutil 1
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey.exe e 14 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: cargo clippy
      run: |-
        flowey.exe e 14 flowey_lib_common::run_cargo_clippy 0
        flowey.exe e 14 flowey_lib_hvlite::init_cross_build 0
        flowey.exe e 14 flowey_lib_hvlite::init_cross_build 4
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey.exe e 14 flowey_lib_common::run_cargo_build 1
        flowey.exe e 14 flowey_lib_hvlite::run_cargo_build 1
        flowey.exe e 14 flowey_lib_hvlite::build_xtask 1
      shell: bash
    - name: determine clippy exclusions
      run: flowey.exe e 14 flowey_lib_hvlite::_jobs::check_clippy 0
      shell: bash
    - name: cargo clippy
      run: flowey.exe e 14 flowey_lib_common::run_cargo_clippy 1
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey.exe e 14 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 14 flowey_lib_common::cache 0
        flowey.exe v 14 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey.exe v 14 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: cargo-nextest'
    - name: report $CARGO_HOME
      run: |-
        flowey.exe v 14 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 14 flowey_lib_common::cache 2
        flowey.exe e 14 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey.exe e 14 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: |-
        flowey.exe e 14 flowey_lib_common::download_cargo_nextest 1
        flowey.exe e 14 flowey_lib_hvlite::init_cross_build 5
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey.exe e 14 flowey_lib_common::run_cargo_build 2
        flowey.exe e 14 flowey_lib_hvlite::run_cargo_build 2
        flowey.exe e 14 flowey_lib_hvlite::build_xtask 2
      shell: bash
    - name: determine unit test exclusions
      run: |-
        flowey.exe e 14 flowey_lib_hvlite::build_nextest_unit_tests 0
        flowey.exe e 14 flowey_lib_hvlite::init_cross_build 2
        flowey.exe e 14 flowey_lib_hvlite::run_cargo_nextest_run 0
      shell: bash
    - name: run 'unit-tests' nextest tests
      run: |-
        flowey.exe e 14 flowey_lib_common::run_cargo_nextest_run 0
        flowey.exe e 14 flowey_lib_common::run_cargo_nextest_run 1
        flowey.exe e 14 flowey_lib_hvlite::_jobs::build_and_run_nextest_unit_tests 0
        flowey.exe e 14 flowey_lib_common::publish_test_results 0
        flowey.exe e 14 flowey_lib_common::publish_test_results 1
        flowey.exe e 14 flowey_lib_common::publish_test_results 2
        flowey.exe v 14 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey.exe v 14 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-unit-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: x64-windows-unit-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey.exe e 14 flowey_lib_hvlite::_jobs::build_and_run_nextest_unit_tests 1
      shell: bash
    - name: run doctests for x86_64-pc-windows-msvc
      run: flowey.exe e 14 flowey_lib_hvlite::_jobs::build_and_run_doc_tests 0
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey.exe e 14 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 14 flowey_lib_common::cache 7
      shell: bash
  job15:
    name: clippy [linux, macos], unit tests [x64-linux]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 15 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 15 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 15 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: add default cargo home to path
      run: flowey e 15 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 15 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 15 flowey_lib_common::install_rust 2
        flowey e 15 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 15 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 15 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 15 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 15 flowey_lib_common::cache 4
        flowey v 15 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar4 --is-raw-string
        flowey v 15 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar5 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar4 }}
        path: ${{ env.floweyvar5 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 15 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey e 15 flowey_lib_common::cache 6
        flowey e 15 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.x64.zip
      run: flowey e 15 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.AARCH64.zip
      run: flowey e 15 flowey_lib_hvlite::download_lxutil 1
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 15 flowey_lib_common::git_checkout 0
        flowey v 15 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar6 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 15 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar6 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 15 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 15 flowey_lib_common::git_checkout 3
        flowey e 15 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey e 15 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey e 15 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 15 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: flowey e 15 flowey_lib_common::download_protoc 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey e 15 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey e 15 flowey_lib_hvlite::init_cross_build 1
        flowey e 15 flowey_lib_hvlite::init_cross_build 6
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey e 15 flowey_lib_common::run_cargo_build 3
        flowey e 15 flowey_lib_hvlite::run_cargo_build 2
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 15 flowey_lib_hvlite::run_split_debug_info 0
        flowey e 15 flowey_lib_hvlite::run_cargo_build 3
        flowey e 15 flowey_lib_hvlite::build_xtask 1
      shell: bash
    - name: determine clippy exclusions
      run: flowey e 15 flowey_lib_hvlite::_jobs::check_clippy 2
      shell: bash
    - name: cargo clippy
      run: |-
        flowey e 15 flowey_lib_common::run_cargo_clippy 1
        flowey e 15 flowey_lib_hvlite::init_cross_build 0
        flowey e 15 flowey_lib_hvlite::init_cross_build 5
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey e 15 flowey_lib_common::run_cargo_build 2
        flowey e 15 flowey_lib_hvlite::run_cargo_build 0
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 15 flowey_lib_hvlite::run_split_debug_info 3
        flowey e 15 flowey_lib_hvlite::run_cargo_build 1
        flowey e 15 flowey_lib_hvlite::build_xtask 0
      shell: bash
    - name: determine clippy exclusions
      run: flowey e 15 flowey_lib_hvlite::_jobs::check_clippy 1
      shell: bash
    - name: cargo clippy
      run: |-
        flowey e 15 flowey_lib_common::run_cargo_clippy 0
        flowey e 15 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey e 15 flowey_lib_common::run_cargo_build 0
        flowey e 15 flowey_lib_hvlite::run_cargo_build 4
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 15 flowey_lib_hvlite::run_split_debug_info 1
        flowey e 15 flowey_lib_hvlite::run_cargo_build 5
        flowey e 15 flowey_lib_hvlite::build_xtask 2
      shell: bash
    - name: determine clippy exclusions
      run: flowey e 15 flowey_lib_hvlite::_jobs::check_clippy 0
      shell: bash
    - name: cargo clippy
      run: flowey e 15 flowey_lib_common::run_cargo_clippy 2
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey e 15 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 15 flowey_lib_common::cache 0
        flowey v 15 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey v 15 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: cargo-nextest'
    - name: report $CARGO_HOME
      run: |-
        flowey v 15 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 15 flowey_lib_common::cache 2
        flowey e 15 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey e 15 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: |-
        flowey e 15 flowey_lib_common::download_cargo_nextest 1
        flowey e 15 flowey_lib_hvlite::init_cross_build 4
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey e 15 flowey_lib_common::run_cargo_build 1
        flowey e 15 flowey_lib_hvlite::run_cargo_build 6
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 15 flowey_lib_hvlite::run_split_debug_info 2
        flowey e 15 flowey_lib_hvlite::run_cargo_build 7
        flowey e 15 flowey_lib_hvlite::build_xtask 3
      shell: bash
    - name: determine unit test exclusions
      run: |-
        flowey e 15 flowey_lib_hvlite::build_nextest_unit_tests 0
        flowey e 15 flowey_lib_hvlite::init_cross_build 2
        flowey e 15 flowey_lib_hvlite::run_cargo_nextest_run 0
      shell: bash
    - name: run 'unit-tests' nextest tests
      run: |-
        flowey e 15 flowey_lib_common::run_cargo_nextest_run 0
        flowey e 15 flowey_lib_common::run_cargo_nextest_run 1
        flowey e 15 flowey_lib_hvlite::_jobs::build_and_run_nextest_unit_tests 0
        flowey e 15 flowey_lib_common::publish_test_results 0
        flowey e 15 flowey_lib_common::publish_test_results 1
        flowey e 15 flowey_lib_common::publish_test_results 2
        flowey v 15 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey v 15 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-unit-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: x64-linux-unit-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey e 15 flowey_lib_hvlite::_jobs::build_and_run_nextest_unit_tests 1
      shell: bash
    - name: run doctests for x86_64-unknown-linux-gnu
      run: flowey e 15 flowey_lib_hvlite::_jobs::build_and_run_doc_tests 0
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey e 15 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 15 flowey_lib_common::cache 7
      shell: bash
  job16:
    name: clippy [linux-musl, misc nostd], unit tests [x64-linux-musl]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 16 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 16 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 16 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: add default cargo home to path
      run: flowey e 16 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 16 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 16 flowey_lib_common::install_rust 2
        flowey e 16 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 16 flowey_lib_common::git_checkout 0
        flowey v 16 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar6 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 16 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar6 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 16 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 16 flowey_lib_common::git_checkout 3
        flowey e 16 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey e 16 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 16 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 16 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 16 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 16 flowey_lib_common::cache 4
        flowey v 16 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar4 --is-raw-string
        flowey v 16 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar5 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar4 }}
        path: ${{ env.floweyvar5 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 16 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey e 16 flowey_lib_common::cache 6
        flowey e 16 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey e 16 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: extract X64 sysroot.tar.gz
      run: flowey e 16 flowey_lib_hvlite::init_openvmm_magicpath_openhcl_sysroot 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.x64.zip
      run: flowey e 16 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.AARCH64.zip
      run: flowey e 16 flowey_lib_hvlite::download_lxutil 1
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey e 16 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 16 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: flowey e 16 flowey_lib_common::download_protoc 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey e 16 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey e 16 flowey_lib_hvlite::init_cross_build 4
        flowey e 16 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey e 16 flowey_lib_common::run_cargo_build 1
        flowey e 16 flowey_lib_hvlite::run_cargo_build 0
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 16 flowey_lib_hvlite::run_split_debug_info 2
        flowey e 16 flowey_lib_hvlite::run_cargo_build 1
        flowey e 16 flowey_lib_hvlite::build_xtask 0
      shell: bash
    - name: determine clippy exclusions
      run: flowey e 16 flowey_lib_hvlite::_jobs::check_clippy 1
      shell: bash
    - name: cargo clippy
      run: flowey e 16 flowey_lib_common::run_cargo_clippy 0
      shell: bash
    - name: cargo clippy
      run: flowey e 16 flowey_lib_common::run_cargo_clippy 2
      shell: bash
    - name: cargo clippy
      run: flowey e 16 flowey_lib_common::run_cargo_clippy 1
      shell: bash
    - name: extract Aarch64 sysroot.tar.gz
      run: |-
        flowey e 16 flowey_lib_hvlite::init_openvmm_magicpath_openhcl_sysroot 0
        flowey e 16 flowey_lib_hvlite::init_cross_build 0
      shell: bash
    - name: cargo clippy
      run: |-
        flowey e 16 flowey_lib_common::run_cargo_clippy 4
        flowey e 16 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey e 16 flowey_lib_common::run_cargo_build 2
        flowey e 16 flowey_lib_hvlite::run_cargo_build 2
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 16 flowey_lib_hvlite::run_split_debug_info 0
        flowey e 16 flowey_lib_hvlite::run_cargo_build 3
        flowey e 16 flowey_lib_hvlite::build_xtask 1
      shell: bash
    - name: determine clippy exclusions
      run: flowey e 16 flowey_lib_hvlite::_jobs::check_clippy 0
      shell: bash
    - name: cargo clippy
      run: flowey e 16 flowey_lib_common::run_cargo_clippy 3
      shell: bash
    - name: cargo clippy
      run: flowey e 16 flowey_lib_common::run_cargo_clippy 5
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey e 16 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 16 flowey_lib_common::cache 0
        flowey v 16 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey v 16 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: cargo-nextest'
    - name: report $CARGO_HOME
      run: |-
        flowey v 16 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 16 flowey_lib_common::cache 2
        flowey e 16 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey e 16 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: |-
        flowey e 16 flowey_lib_common::download_cargo_nextest 1
        flowey e 16 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey e 16 flowey_lib_common::run_cargo_build 0
        flowey e 16 flowey_lib_hvlite::run_cargo_build 4
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 16 flowey_lib_hvlite::run_split_debug_info 1
        flowey e 16 flowey_lib_hvlite::run_cargo_build 5
        flowey e 16 flowey_lib_hvlite::build_xtask 2
      shell: bash
    - name: determine unit test exclusions
      run: |-
        flowey e 16 flowey_lib_hvlite::build_nextest_unit_tests 0
        flowey e 16 flowey_lib_hvlite::init_cross_build 5
        flowey e 16 flowey_lib_hvlite::run_cargo_nextest_run 0
      shell: bash
    - name: run 'unit-tests' nextest tests
      run: |-
        flowey e 16 flowey_lib_common::run_cargo_nextest_run 0
        flowey e 16 flowey_lib_common::run_cargo_nextest_run 1
        flowey e 16 flowey_lib_hvlite::_jobs::build_and_run_nextest_unit_tests 0
        flowey e 16 flowey_lib_common::publish_test_results 0
        flowey e 16 flowey_lib_common::publish_test_results 1
        flowey e 16 flowey_lib_common::publish_test_results 2
        flowey v 16 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey v 16 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-musl-unit-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: x64-linux-musl-unit-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey e 16 flowey_lib_hvlite::_jobs::build_and_run_nextest_unit_tests 1
      shell: bash
    - name: run doctests for x86_64-unknown-linux-musl
      run: flowey e 16 flowey_lib_hvlite::_jobs::build_and_run_doc_tests 0
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey e 16 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 16 flowey_lib_common::cache 7
      shell: bash
  job17:
    name: unit tests [aarch64-windows]
    runs-on:
    - self-hosted
    - Windows
    - ARM64
    - Baremetal
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target aarch64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/aarch64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 17 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 17 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 17 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: create cargo-nextest cache dir
      run: |-
        flowey.exe e 17 flowey_lib_common::cfg_cargo_common_flags 0
        flowey.exe e 17 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 17 flowey_lib_common::cache 0
        flowey.exe v 17 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey.exe v 17 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: cargo-nextest'
    - name: add default cargo home to path
      run: |-
        flowey.exe v 17 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 17 flowey_lib_common::cache 2
        flowey.exe e 17 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey.exe e 17 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 17 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: flowey.exe e 17 flowey_lib_common::install_rust 2
      shell: bash
    - name: report $CARGO_HOME
      run: flowey.exe e 17 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: flowey.exe e 17 flowey_lib_common::download_cargo_nextest 1
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 17 flowey_lib_common::git_checkout 0
        flowey.exe v 17 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar6 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 17 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar6 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 17 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 17 flowey_lib_common::git_checkout 3
        flowey.exe e 17 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey.exe e 17 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 17 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 17 flowey_lib_common::cache 4
        flowey.exe v 17 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar4 --is-raw-string
        flowey.exe v 17 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar5 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar4 }}
        path: ${{ env.floweyvar5 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 17 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey.exe e 17 flowey_lib_common::cache 6
        flowey.exe e 17 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack protoc
      run: |-
        flowey.exe e 17 flowey_lib_common::download_protoc 0
        flowey.exe e 17 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey.exe e 17 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey.exe e 17 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey.exe e 17 flowey_lib_common::run_cargo_build 0
        flowey.exe e 17 flowey_lib_hvlite::run_cargo_build 0
        flowey.exe e 17 flowey_lib_hvlite::build_xtask 0
      shell: bash
    - name: determine unit test exclusions
      run: flowey.exe e 17 flowey_lib_hvlite::build_nextest_unit_tests 0
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.AARCH64.zip
      run: flowey.exe e 17 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: |-
        flowey.exe e 17 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
        flowey.exe e 17 flowey_lib_hvlite::init_cross_build 0
        flowey.exe e 17 flowey_lib_hvlite::run_cargo_nextest_run 0
      shell: bash
    - name: run 'unit-tests' nextest tests
      run: |-
        flowey.exe e 17 flowey_lib_common::run_cargo_nextest_run 0
        flowey.exe e 17 flowey_lib_common::run_cargo_nextest_run 1
        flowey.exe e 17 flowey_lib_hvlite::_jobs::build_and_run_nextest_unit_tests 0
        flowey.exe e 17 flowey_lib_common::publish_test_results 0
        flowey.exe e 17 flowey_lib_common::publish_test_results 1
        flowey.exe e 17 flowey_lib_common::publish_test_results 2
        flowey.exe v 17 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey.exe v 17 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-unit-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: aarch64-windows-unit-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey.exe e 17 flowey_lib_hvlite::_jobs::build_and_run_nextest_unit_tests 1
      shell: bash
    - name: run doctests for aarch64-pc-windows-msvc
      run: flowey.exe e 17 flowey_lib_hvlite::_jobs::build_and_run_doc_tests 0
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey.exe e 17 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 17 flowey_lib_common::cache 7
      shell: bash
  job18:
    name: run vmm-tests [x64-windows-intel]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Win-Pool-Intel-WestUS3
    - 1ES.ImageOverride=HvLite-CI-Win-Ge-Image-256GB
    permissions:
      contents: read
      id-token: write
    needs:
    - job12
    - job12
    - job12
    - job10
    - job10
    - job7
    - job8
    - job8
    - job8
    if: github.event.pull_request.draft == false
    steps:
    - name: ðŸŒ¼ðŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '{_internal-flowey-bootstrap-x86_64-windows-uid-11,x64-guest_test_uefi,x64-linux-musl-pipette,x64-linux-musl-tmk_vmm,x64-openhcl-igvm,x64-tmks,x64-windows-openvmm,x64-windows-pipette,x64-windows-tmk_vmm,x64-windows-vmm-tests-archive}'
        path: ${{ runner.temp }}/used_artifacts/
    - run: echo "${{ runner.temp }}/used_artifacts/_internal-flowey-bootstrap-x86_64-windows-uid-11" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/used_artifacts/_internal-flowey-bootstrap-x86_64-windows-uid-11/flowey.exe

        echo '"debug"' | flowey.exe v 18 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 18 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 18 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        echo "${{ runner.temp }}\\used_artifacts\\x64-guest_test_uefi" | flowey.exe v 18 'artifact_use_from_x64-guest_test_uefi' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-linux-musl-pipette" | flowey.exe v 18 'artifact_use_from_x64-linux-musl-pipette' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-linux-musl-tmk_vmm" | flowey.exe v 18 'artifact_use_from_x64-linux-musl-tmk_vmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-openhcl-igvm" | flowey.exe v 18 'artifact_use_from_x64-openhcl-igvm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-tmks" | flowey.exe v 18 'artifact_use_from_x64-tmks' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-openvmm" | flowey.exe v 18 'artifact_use_from_x64-windows-openvmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-pipette" | flowey.exe v 18 'artifact_use_from_x64-windows-pipette' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-tmk_vmm" | flowey.exe v 18 'artifact_use_from_x64-windows-tmk_vmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-vmm-tests-archive" | flowey.exe v 18 'artifact_use_from_x64-windows-vmm-tests-archive' --update-from-stdin --is-raw-string
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey.exe e 18 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 18 flowey_lib_common::cache 4
        flowey.exe v 18 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar7 --is-raw-string
        flowey.exe v 18 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar8 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar7 }}
        path: ${{ env.floweyvar8 }}
      name: 'Restore cache: cargo-nextest'
    - name: add default cargo home to path
      run: |-
        flowey.exe v 18 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey.exe e 18 flowey_lib_common::cache 6
        flowey.exe e 18 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey.exe e 18 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 18 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: flowey.exe e 18 flowey_lib_common::install_rust 2
      shell: bash
    - name: report $CARGO_HOME
      run: flowey.exe e 18 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: flowey.exe e 18 flowey_lib_common::download_cargo_nextest 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 18 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 18 flowey_lib_common::cache 8
        flowey.exe v 18 'flowey_lib_common::cache:18:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar9 --is-raw-string
        flowey.exe v 18 'flowey_lib_common::cache:17:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar10 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__9
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar9 }}
        path: ${{ env.floweyvar10 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 18 'flowey_lib_common::cache:20:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__9.outputs.cache-hit }}
        EOF
        flowey.exe e 18 flowey_lib_common::cache 10
        flowey.exe e 18 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack mu_msvm package (x64)
      run: flowey.exe e 18 flowey_lib_hvlite::download_uefi_mu_msvm 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 18 flowey_lib_common::git_checkout 0
        flowey.exe v 18 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar4 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 18 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar4 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 18 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 18 flowey_lib_common::git_checkout 3
        flowey.exe e 18 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey.exe e 18 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move MSVM.fd into its magic folder
      run: flowey.exe e 18 flowey_lib_hvlite::init_openvmm_magicpath_uefi_mu_msvm 0
      shell: bash
    - name: init hyperv tests
      run: |-
        flowey.exe e 18 flowey_lib_hvlite::init_hyperv_tests 0
        flowey.exe e 18 flowey_lib_hvlite::run_cargo_nextest_run 0
        flowey.exe e 18 flowey_core::pipeline::artifact::resolve 4
        flowey.exe e 18 flowey_core::pipeline::artifact::resolve 5
        flowey.exe e 18 flowey_core::pipeline::artifact::resolve 1
        flowey.exe e 18 flowey_core::pipeline::artifact::resolve 0
        flowey.exe e 18 flowey_core::pipeline::artifact::resolve 6
        flowey.exe e 18 flowey_core::pipeline::artifact::resolve 2
        flowey.exe e 18 flowey_core::pipeline::artifact::resolve 3
      shell: bash
    - name: creating new test content dir
      run: flowey.exe e 18 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 0
      shell: bash
    - name: resolve OpenHCL igvm artifact
      run: flowey.exe e 18 flowey_lib_hvlite::artifact_openhcl_igvm_from_recipe::resolve 0
      shell: bash
    - name: create azcopy cache dir
      run: flowey.exe e 18 flowey_lib_common::download_azcopy 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 18 flowey_lib_common::cache 0
        flowey.exe v 18 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar5 --is-raw-string
        flowey.exe v 18 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar6 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar5 }}
        path: ${{ env.floweyvar6 }}
      name: 'Restore cache: azcopy'
    - name: installing azcopy
      run: |-
        flowey.exe v 18 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 18 flowey_lib_common::cache 2
        flowey.exe e 18 flowey_lib_common::download_azcopy 1
      shell: bash
    - name: calculating required VMM tests disk images
      run: flowey.exe e 18 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 0
      shell: bash
    - name: downloading VMM test disk images
      run: |-
        flowey.exe e 18 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 1
        flowey.exe e 18 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 2
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey.exe e 18 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: setting up vmm_tests env
      run: |-
        flowey.exe e 18 flowey_lib_hvlite::init_vmm_tests_env 0
        flowey.exe e 18 flowey_lib_hvlite::run_cargo_nextest_run 1
        flowey.exe e 18 flowey_core::pipeline::artifact::resolve 7
        flowey.exe e 18 flowey_lib_hvlite::test_nextest_vmm_tests_archive 0
      shell: bash
    - name: run 'vmm_tests' nextest tests
      run: |-
        flowey.exe e 18 flowey_lib_common::run_cargo_nextest_run 0
        flowey.exe e 18 flowey_lib_common::run_cargo_nextest_run 1
        flowey.exe e 18 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 2
        flowey.exe e 18 flowey_lib_common::publish_test_results 4
        flowey.exe e 18 flowey_lib_common::publish_test_results 5
        flowey.exe v 18 'flowey_lib_common::publish_test_results:9:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar2 --is-raw-string --condvar flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey.exe v 18 'flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__6
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-intel-vmm-tests-crash-dumps
        path: ${{ env.floweyvar2 }}
      name: 'publish test results: crash-dumps (x64-windows-intel-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey.exe e 18 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 1
        flowey.exe e 18 flowey_lib_common::publish_test_results 7
        flowey.exe e 18 flowey_lib_common::publish_test_results 8
        flowey.exe v 18 'flowey_lib_common::publish_test_results:14:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey.exe v 18 'flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__9
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-intel-vmm-tests-logs
        path: ${{ env.floweyvar3 }}
      name: 'publish test results: logs (x64-windows-intel-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey.exe e 18 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 3
        flowey.exe e 18 flowey_lib_common::publish_test_results 0
        flowey.exe e 18 flowey_lib_common::publish_test_results 1
        flowey.exe e 18 flowey_lib_common::publish_test_results 2
        flowey.exe v 18 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey.exe v 18 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-intel-vmm-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: x64-windows-intel-vmm-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey.exe e 18 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 4
      shell: bash
    - name: 'validate cache entry: azcopy'
      run: flowey.exe e 18 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey.exe e 18 flowey_lib_common::cache 7
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 18 flowey_lib_common::cache 11
      shell: bash
  job19:
    name: run vmm-tests [x64-windows-intel-tdx]
    runs-on:
    - self-hosted
    - Windows
    - X64
    - TDX
    - Baremetal
    permissions:
      contents: read
      id-token: write
    needs:
    - job12
    - job12
    - job12
    - job10
    - job10
    - job7
    - job8
    - job8
    - job8
    if: github.event.pull_request.draft == false
    steps:
    - name: ðŸŒ¼ðŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '{_internal-flowey-bootstrap-x86_64-windows-uid-11,x64-guest_test_uefi,x64-linux-musl-pipette,x64-linux-musl-tmk_vmm,x64-openhcl-igvm,x64-tmks,x64-windows-openvmm,x64-windows-pipette,x64-windows-tmk_vmm,x64-windows-vmm-tests-archive}'
        path: ${{ runner.temp }}/used_artifacts/
    - run: echo "${{ runner.temp }}/used_artifacts/_internal-flowey-bootstrap-x86_64-windows-uid-11" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/used_artifacts/_internal-flowey-bootstrap-x86_64-windows-uid-11/flowey.exe

        echo '"debug"' | flowey.exe v 19 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 19 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 19 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        echo "${{ runner.temp }}\\used_artifacts\\x64-guest_test_uefi" | flowey.exe v 19 'artifact_use_from_x64-guest_test_uefi' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-linux-musl-pipette" | flowey.exe v 19 'artifact_use_from_x64-linux-musl-pipette' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-linux-musl-tmk_vmm" | flowey.exe v 19 'artifact_use_from_x64-linux-musl-tmk_vmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-openhcl-igvm" | flowey.exe v 19 'artifact_use_from_x64-openhcl-igvm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-tmks" | flowey.exe v 19 'artifact_use_from_x64-tmks' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-openvmm" | flowey.exe v 19 'artifact_use_from_x64-windows-openvmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-pipette" | flowey.exe v 19 'artifact_use_from_x64-windows-pipette' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-tmk_vmm" | flowey.exe v 19 'artifact_use_from_x64-windows-tmk_vmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-vmm-tests-archive" | flowey.exe v 19 'artifact_use_from_x64-windows-vmm-tests-archive' --update-from-stdin --is-raw-string
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey.exe e 19 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 19 flowey_lib_common::cache 4
        flowey.exe v 19 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar7 --is-raw-string
        flowey.exe v 19 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar8 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar7 }}
        path: ${{ env.floweyvar8 }}
      name: 'Restore cache: cargo-nextest'
    - name: add default cargo home to path
      run: |-
        flowey.exe v 19 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey.exe e 19 flowey_lib_common::cache 6
        flowey.exe e 19 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey.exe e 19 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 19 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: flowey.exe e 19 flowey_lib_common::install_rust 2
      shell: bash
    - name: report $CARGO_HOME
      run: flowey.exe e 19 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: flowey.exe e 19 flowey_lib_common::download_cargo_nextest 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 19 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 19 flowey_lib_common::cache 8
        flowey.exe v 19 'flowey_lib_common::cache:18:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar9 --is-raw-string
        flowey.exe v 19 'flowey_lib_common::cache:17:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar10 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__9
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar9 }}
        path: ${{ env.floweyvar10 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 19 'flowey_lib_common::cache:20:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__9.outputs.cache-hit }}
        EOF
        flowey.exe e 19 flowey_lib_common::cache 10
        flowey.exe e 19 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack mu_msvm package (x64)
      run: flowey.exe e 19 flowey_lib_hvlite::download_uefi_mu_msvm 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 19 flowey_lib_common::git_checkout 0
        flowey.exe v 19 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar4 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 19 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar4 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 19 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 19 flowey_lib_common::git_checkout 3
        flowey.exe e 19 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey.exe e 19 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move MSVM.fd into its magic folder
      run: flowey.exe e 19 flowey_lib_hvlite::init_openvmm_magicpath_uefi_mu_msvm 0
      shell: bash
    - name: init hyperv tests
      run: |-
        flowey.exe e 19 flowey_lib_hvlite::init_hyperv_tests 0
        flowey.exe e 19 flowey_lib_hvlite::run_cargo_nextest_run 0
        flowey.exe e 19 flowey_core::pipeline::artifact::resolve 4
        flowey.exe e 19 flowey_core::pipeline::artifact::resolve 5
        flowey.exe e 19 flowey_core::pipeline::artifact::resolve 1
        flowey.exe e 19 flowey_core::pipeline::artifact::resolve 0
        flowey.exe e 19 flowey_core::pipeline::artifact::resolve 6
        flowey.exe e 19 flowey_core::pipeline::artifact::resolve 2
        flowey.exe e 19 flowey_core::pipeline::artifact::resolve 3
      shell: bash
    - name: creating new test content dir
      run: flowey.exe e 19 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 0
      shell: bash
    - name: resolve OpenHCL igvm artifact
      run: flowey.exe e 19 flowey_lib_hvlite::artifact_openhcl_igvm_from_recipe::resolve 0
      shell: bash
    - name: create azcopy cache dir
      run: flowey.exe e 19 flowey_lib_common::download_azcopy 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 19 flowey_lib_common::cache 0
        flowey.exe v 19 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar5 --is-raw-string
        flowey.exe v 19 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar6 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar5 }}
        path: ${{ env.floweyvar6 }}
      name: 'Restore cache: azcopy'
    - name: installing azcopy
      run: |-
        flowey.exe v 19 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 19 flowey_lib_common::cache 2
        flowey.exe e 19 flowey_lib_common::download_azcopy 1
      shell: bash
    - name: calculating required VMM tests disk images
      run: flowey.exe e 19 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 0
      shell: bash
    - name: downloading VMM test disk images
      run: |-
        flowey.exe e 19 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 1
        flowey.exe e 19 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 2
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey.exe e 19 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: setting up vmm_tests env
      run: |-
        flowey.exe e 19 flowey_lib_hvlite::init_vmm_tests_env 0
        flowey.exe e 19 flowey_lib_hvlite::run_cargo_nextest_run 1
        flowey.exe e 19 flowey_core::pipeline::artifact::resolve 7
        flowey.exe e 19 flowey_lib_hvlite::test_nextest_vmm_tests_archive 0
      shell: bash
    - name: run 'vmm_tests' nextest tests
      run: |-
        flowey.exe e 19 flowey_lib_common::run_cargo_nextest_run 0
        flowey.exe e 19 flowey_lib_common::run_cargo_nextest_run 1
        flowey.exe e 19 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 2
        flowey.exe e 19 flowey_lib_common::publish_test_results 4
        flowey.exe e 19 flowey_lib_common::publish_test_results 5
        flowey.exe v 19 'flowey_lib_common::publish_test_results:9:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar2 --is-raw-string --condvar flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey.exe v 19 'flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__6
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-intel-tdx-vmm-tests-crash-dumps
        path: ${{ env.floweyvar2 }}
      name: 'publish test results: crash-dumps (x64-windows-intel-tdx-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey.exe e 19 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 1
        flowey.exe e 19 flowey_lib_common::publish_test_results 7
        flowey.exe e 19 flowey_lib_common::publish_test_results 8
        flowey.exe v 19 'flowey_lib_common::publish_test_results:14:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey.exe v 19 'flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__9
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-intel-tdx-vmm-tests-logs
        path: ${{ env.floweyvar3 }}
      name: 'publish test results: logs (x64-windows-intel-tdx-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey.exe e 19 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 3
        flowey.exe e 19 flowey_lib_common::publish_test_results 0
        flowey.exe e 19 flowey_lib_common::publish_test_results 1
        flowey.exe e 19 flowey_lib_common::publish_test_results 2
        flowey.exe v 19 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey.exe v 19 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-intel-tdx-vmm-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: x64-windows-intel-tdx-vmm-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey.exe e 19 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 4
      shell: bash
    - name: 'validate cache entry: azcopy'
      run: flowey.exe e 19 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey.exe e 19 flowey_lib_common::cache 7
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 19 flowey_lib_common::cache 11
      shell: bash
  job2:
    name: build and check docs [x64-linux]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 2 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 2 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 2 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-linux-rustdoc"
        echo "$AgentTempDirNormal/publish_artifacts/x64-linux-rustdoc" | flowey v 2 'artifact_publish_from_x64-linux-rustdoc' --update-from-stdin --is-raw-string
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 2 flowey_lib_common::git_checkout 0
        flowey v 2 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 2 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar3 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 2 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 2 flowey_lib_common::git_checkout 3
        flowey e 2 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 2 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 2 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 2 flowey_lib_common::cache 0
        flowey v 2 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar1 --is-raw-string
        flowey v 2 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar2 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar1 }}
        path: ${{ env.floweyvar2 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 2 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 2 flowey_lib_common::cache 2
        flowey e 2 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 2 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 2 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: unpack protoc
      run: |-
        flowey e 2 flowey_lib_common::download_protoc 0
        flowey e 2 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: flowey e 2 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
      shell: bash
    - name: add default cargo home to path
      run: flowey e 2 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 2 flowey_lib_common::install_rust 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.x64.zip
      run: flowey e 2 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey e 2 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 2 flowey_lib_common::install_rust 2
        flowey e 2 flowey_lib_common::cfg_cargo_common_flags 0
        flowey e 2 flowey_lib_common::run_cargo_doc 0
      shell: bash
    - name: document repo for target x86_64-unknown-linux-gnu
      run: flowey e 2 flowey_lib_hvlite::build_rustdoc 0
      shell: bash
    - name: archive rustdoc dir
      run: |-
        flowey e 2 flowey_lib_hvlite::artifact_rustdoc::publish 0
        flowey e 2 flowey_lib_hvlite::artifact_rustdoc::publish 1
      shell: bash
    - name: copying rustdoc to artifact dir
      run: flowey e 2 flowey_lib_common::copy_to_artifact_dir 0
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 2 flowey_lib_common::cache 3
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish x64-linux-rustdoc
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-rustdoc
        path: ${{ runner.temp }}/publish_artifacts/x64-linux-rustdoc/
  job20:
    name: run vmm-tests [x64-windows-amd]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Win-Pool-WestUS3
    - 1ES.ImageOverride=HvLite-CI-Win-Ge-Image-256GB
    permissions:
      contents: read
      id-token: write
    needs:
    - job12
    - job12
    - job12
    - job10
    - job10
    - job7
    - job8
    - job8
    - job8
    if: github.event.pull_request.draft == false
    steps:
    - name: ðŸŒ¼ðŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '{_internal-flowey-bootstrap-x86_64-windows-uid-11,x64-guest_test_uefi,x64-linux-musl-pipette,x64-linux-musl-tmk_vmm,x64-openhcl-igvm,x64-tmks,x64-windows-openvmm,x64-windows-pipette,x64-windows-tmk_vmm,x64-windows-vmm-tests-archive}'
        path: ${{ runner.temp }}/used_artifacts/
    - run: echo "${{ runner.temp }}/used_artifacts/_internal-flowey-bootstrap-x86_64-windows-uid-11" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/used_artifacts/_internal-flowey-bootstrap-x86_64-windows-uid-11/flowey.exe

        echo '"debug"' | flowey.exe v 20 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 20 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 20 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        echo "${{ runner.temp }}\\used_artifacts\\x64-guest_test_uefi" | flowey.exe v 20 'artifact_use_from_x64-guest_test_uefi' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-linux-musl-pipette" | flowey.exe v 20 'artifact_use_from_x64-linux-musl-pipette' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-linux-musl-tmk_vmm" | flowey.exe v 20 'artifact_use_from_x64-linux-musl-tmk_vmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-openhcl-igvm" | flowey.exe v 20 'artifact_use_from_x64-openhcl-igvm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-tmks" | flowey.exe v 20 'artifact_use_from_x64-tmks' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-openvmm" | flowey.exe v 20 'artifact_use_from_x64-windows-openvmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-pipette" | flowey.exe v 20 'artifact_use_from_x64-windows-pipette' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-tmk_vmm" | flowey.exe v 20 'artifact_use_from_x64-windows-tmk_vmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\x64-windows-vmm-tests-archive" | flowey.exe v 20 'artifact_use_from_x64-windows-vmm-tests-archive' --update-from-stdin --is-raw-string
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey.exe e 20 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 20 flowey_lib_common::cache 4
        flowey.exe v 20 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar7 --is-raw-string
        flowey.exe v 20 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar8 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar7 }}
        path: ${{ env.floweyvar8 }}
      name: 'Restore cache: cargo-nextest'
    - name: add default cargo home to path
      run: |-
        flowey.exe v 20 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey.exe e 20 flowey_lib_common::cache 6
        flowey.exe e 20 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey.exe e 20 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 20 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: flowey.exe e 20 flowey_lib_common::install_rust 2
      shell: bash
    - name: report $CARGO_HOME
      run: flowey.exe e 20 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: flowey.exe e 20 flowey_lib_common::download_cargo_nextest 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 20 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 20 flowey_lib_common::cache 8
        flowey.exe v 20 'flowey_lib_common::cache:18:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar9 --is-raw-string
        flowey.exe v 20 'flowey_lib_common::cache:17:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar10 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__9
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar9 }}
        path: ${{ env.floweyvar10 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 20 'flowey_lib_common::cache:20:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__9.outputs.cache-hit }}
        EOF
        flowey.exe e 20 flowey_lib_common::cache 10
        flowey.exe e 20 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack mu_msvm package (x64)
      run: flowey.exe e 20 flowey_lib_hvlite::download_uefi_mu_msvm 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 20 flowey_lib_common::git_checkout 0
        flowey.exe v 20 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar4 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 20 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar4 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 20 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 20 flowey_lib_common::git_checkout 3
        flowey.exe e 20 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey.exe e 20 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move MSVM.fd into its magic folder
      run: flowey.exe e 20 flowey_lib_hvlite::init_openvmm_magicpath_uefi_mu_msvm 0
      shell: bash
    - name: init hyperv tests
      run: |-
        flowey.exe e 20 flowey_lib_hvlite::init_hyperv_tests 0
        flowey.exe e 20 flowey_lib_hvlite::run_cargo_nextest_run 0
        flowey.exe e 20 flowey_core::pipeline::artifact::resolve 4
        flowey.exe e 20 flowey_core::pipeline::artifact::resolve 5
        flowey.exe e 20 flowey_core::pipeline::artifact::resolve 1
        flowey.exe e 20 flowey_core::pipeline::artifact::resolve 0
        flowey.exe e 20 flowey_core::pipeline::artifact::resolve 6
        flowey.exe e 20 flowey_core::pipeline::artifact::resolve 2
        flowey.exe e 20 flowey_core::pipeline::artifact::resolve 3
      shell: bash
    - name: creating new test content dir
      run: flowey.exe e 20 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 0
      shell: bash
    - name: resolve OpenHCL igvm artifact
      run: flowey.exe e 20 flowey_lib_hvlite::artifact_openhcl_igvm_from_recipe::resolve 0
      shell: bash
    - name: create azcopy cache dir
      run: flowey.exe e 20 flowey_lib_common::download_azcopy 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 20 flowey_lib_common::cache 0
        flowey.exe v 20 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar5 --is-raw-string
        flowey.exe v 20 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar6 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar5 }}
        path: ${{ env.floweyvar6 }}
      name: 'Restore cache: azcopy'
    - name: installing azcopy
      run: |-
        flowey.exe v 20 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 20 flowey_lib_common::cache 2
        flowey.exe e 20 flowey_lib_common::download_azcopy 1
      shell: bash
    - name: calculating required VMM tests disk images
      run: flowey.exe e 20 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 0
      shell: bash
    - name: downloading VMM test disk images
      run: |-
        flowey.exe e 20 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 1
        flowey.exe e 20 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 2
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey.exe e 20 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: setting up vmm_tests env
      run: |-
        flowey.exe e 20 flowey_lib_hvlite::init_vmm_tests_env 0
        flowey.exe e 20 flowey_lib_hvlite::run_cargo_nextest_run 1
        flowey.exe e 20 flowey_core::pipeline::artifact::resolve 7
        flowey.exe e 20 flowey_lib_hvlite::test_nextest_vmm_tests_archive 0
      shell: bash
    - name: run 'vmm_tests' nextest tests
      run: |-
        flowey.exe e 20 flowey_lib_common::run_cargo_nextest_run 0
        flowey.exe e 20 flowey_lib_common::run_cargo_nextest_run 1
        flowey.exe e 20 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 2
        flowey.exe e 20 flowey_lib_common::publish_test_results 4
        flowey.exe e 20 flowey_lib_common::publish_test_results 5
        flowey.exe v 20 'flowey_lib_common::publish_test_results:9:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar2 --is-raw-string --condvar flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey.exe v 20 'flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__6
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-amd-vmm-tests-crash-dumps
        path: ${{ env.floweyvar2 }}
      name: 'publish test results: crash-dumps (x64-windows-amd-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey.exe e 20 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 1
        flowey.exe e 20 flowey_lib_common::publish_test_results 7
        flowey.exe e 20 flowey_lib_common::publish_test_results 8
        flowey.exe v 20 'flowey_lib_common::publish_test_results:14:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey.exe v 20 'flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__9
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-amd-vmm-tests-logs
        path: ${{ env.floweyvar3 }}
      name: 'publish test results: logs (x64-windows-amd-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey.exe e 20 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 3
        flowey.exe e 20 flowey_lib_common::publish_test_results 0
        flowey.exe e 20 flowey_lib_common::publish_test_results 1
        flowey.exe e 20 flowey_lib_common::publish_test_results 2
        flowey.exe v 20 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey.exe v 20 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-amd-vmm-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: x64-windows-amd-vmm-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey.exe e 20 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 4
      shell: bash
    - name: 'validate cache entry: azcopy'
      run: flowey.exe e 20 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey.exe e 20 flowey_lib_common::cache 7
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 20 flowey_lib_common::cache 11
      shell: bash
  job21:
    name: run vmm-tests [x64-linux]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    needs:
    - job12
    - job12
    - job10
    - job10
    - job10
    - job8
    - job10
    if: github.event.pull_request.draft == false
    steps:
    - name: ðŸŒ¼ðŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '{_internal-flowey-bootstrap-x86_64-linux-uid-7,x64-guest_test_uefi,x64-linux-musl-pipette,x64-linux-musl-tmk_vmm,x64-linux-openvmm,x64-linux-vmm-tests-archive,x64-tmks,x64-windows-pipette}'
        path: ${{ runner.temp }}/used_artifacts/
    - run: echo "${{ runner.temp }}/used_artifacts/_internal-flowey-bootstrap-x86_64-linux-uid-7" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/used_artifacts/_internal-flowey-bootstrap-x86_64-linux-uid-7/flowey

        echo '"debug"' | flowey v 21 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 21 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 21 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        echo "$AgentTempDirNormal/used_artifacts/x64-guest_test_uefi" | flowey v 21 'artifact_use_from_x64-guest_test_uefi' --update-from-stdin --is-raw-string
        echo "$AgentTempDirNormal/used_artifacts/x64-linux-musl-pipette" | flowey v 21 'artifact_use_from_x64-linux-musl-pipette' --update-from-stdin --is-raw-string
        echo "$AgentTempDirNormal/used_artifacts/x64-linux-musl-tmk_vmm" | flowey v 21 'artifact_use_from_x64-linux-musl-tmk_vmm' --update-from-stdin --is-raw-string
        echo "$AgentTempDirNormal/used_artifacts/x64-linux-openvmm" | flowey v 21 'artifact_use_from_x64-linux-openvmm' --update-from-stdin --is-raw-string
        echo "$AgentTempDirNormal/used_artifacts/x64-linux-vmm-tests-archive" | flowey v 21 'artifact_use_from_x64-linux-vmm-tests-archive' --update-from-stdin --is-raw-string
        echo "$AgentTempDirNormal/used_artifacts/x64-tmks" | flowey v 21 'artifact_use_from_x64-tmks' --update-from-stdin --is-raw-string
        echo "$AgentTempDirNormal/used_artifacts/x64-windows-pipette" | flowey v 21 'artifact_use_from_x64-windows-pipette' --update-from-stdin --is-raw-string
      shell: bash
    - name: ensure /dev/kvm is accessible
      run: flowey e 21 flowey_lib_hvlite::test_nextest_vmm_tests_archive 0
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey e 21 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 21 flowey_lib_common::cache 4
        flowey v 21 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar7 --is-raw-string
        flowey v 21 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar8 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar7 }}
        path: ${{ env.floweyvar8 }}
      name: 'Restore cache: cargo-nextest'
    - name: add default cargo home to path
      run: |-
        flowey v 21 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey e 21 flowey_lib_common::cache 6
        flowey e 21 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey e 21 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 21 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: flowey e 21 flowey_lib_common::install_rust 2
      shell: bash
    - name: report $CARGO_HOME
      run: flowey e 21 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: flowey e 21 flowey_lib_common::download_cargo_nextest 1
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 21 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 21 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 21 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 21 flowey_lib_common::cache 8
        flowey v 21 'flowey_lib_common::cache:18:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar9 --is-raw-string
        flowey v 21 'flowey_lib_common::cache:17:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar10 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__9
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar9 }}
        path: ${{ env.floweyvar10 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 21 'flowey_lib_common::cache:20:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__9.outputs.cache-hit }}
        EOF
        flowey e 21 flowey_lib_common::cache 10
        flowey e 21 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack mu_msvm package (x64)
      run: flowey e 21 flowey_lib_hvlite::download_uefi_mu_msvm 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 21 flowey_lib_common::git_checkout 0
        flowey v 21 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar4 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 21 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar4 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 21 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 21 flowey_lib_common::git_checkout 3
        flowey e 21 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey e 21 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move MSVM.fd into its magic folder
      run: |-
        flowey e 21 flowey_lib_hvlite::init_openvmm_magicpath_uefi_mu_msvm 0
        flowey e 21 flowey_lib_hvlite::run_cargo_nextest_run 0
        flowey e 21 flowey_core::pipeline::artifact::resolve 3
        flowey e 21 flowey_core::pipeline::artifact::resolve 6
        flowey e 21 flowey_core::pipeline::artifact::resolve 1
        flowey e 21 flowey_core::pipeline::artifact::resolve 0
        flowey e 21 flowey_core::pipeline::artifact::resolve 2
        flowey e 21 flowey_core::pipeline::artifact::resolve 5
      shell: bash
    - name: creating new test content dir
      run: flowey e 21 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 0
      shell: bash
    - name: create azcopy cache dir
      run: flowey e 21 flowey_lib_common::download_azcopy 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 21 flowey_lib_common::cache 0
        flowey v 21 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar5 --is-raw-string
        flowey v 21 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar6 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar5 }}
        path: ${{ env.floweyvar6 }}
      name: 'Restore cache: azcopy'
    - name: installing azcopy
      run: |-
        flowey v 21 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 21 flowey_lib_common::cache 2
        flowey e 21 flowey_lib_common::download_azcopy 1
      shell: bash
    - name: calculating required VMM tests disk images
      run: flowey e 21 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 0
      shell: bash
    - name: downloading VMM test disk images
      run: |-
        flowey e 21 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 1
        flowey e 21 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 2
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey e 21 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: setting up vmm_tests env
      run: |-
        flowey e 21 flowey_lib_hvlite::init_vmm_tests_env 0
        flowey e 21 flowey_lib_hvlite::run_cargo_nextest_run 1
        flowey e 21 flowey_core::pipeline::artifact::resolve 4
        flowey e 21 flowey_lib_hvlite::test_nextest_vmm_tests_archive 1
      shell: bash
    - name: run 'vmm_tests' nextest tests
      run: |-
        flowey e 21 flowey_lib_common::run_cargo_nextest_run 0
        flowey e 21 flowey_lib_common::run_cargo_nextest_run 1
        flowey e 21 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 2
        flowey e 21 flowey_lib_common::publish_test_results 4
        flowey e 21 flowey_lib_common::publish_test_results 5
        flowey v 21 'flowey_lib_common::publish_test_results:9:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar2 --is-raw-string --condvar flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey v 21 'flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__6
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-vmm-tests-crash-dumps
        path: ${{ env.floweyvar2 }}
      name: 'publish test results: crash-dumps (x64-linux-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey e 21 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 1
        flowey e 21 flowey_lib_common::publish_test_results 7
        flowey e 21 flowey_lib_common::publish_test_results 8
        flowey v 21 'flowey_lib_common::publish_test_results:14:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey v 21 'flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__9
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-vmm-tests-logs
        path: ${{ env.floweyvar3 }}
      name: 'publish test results: logs (x64-linux-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey e 21 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 3
        flowey e 21 flowey_lib_common::publish_test_results 0
        flowey e 21 flowey_lib_common::publish_test_results 1
        flowey e 21 flowey_lib_common::publish_test_results 2
        flowey v 21 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey v 21 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: x64-linux-vmm-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: x64-linux-vmm-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey e 21 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 4
      shell: bash
    - name: 'validate cache entry: azcopy'
      run: flowey e 21 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey e 21 flowey_lib_common::cache 7
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 21 flowey_lib_common::cache 11
      shell: bash
  job22:
    name: run vmm-tests [aarch64-windows]
    runs-on:
    - self-hosted
    - Windows
    - ARM64
    - Baremetal
    permissions:
      contents: read
      id-token: write
    needs:
    - job11
    - job11
    - job11
    - job9
    - job9
    - job5
    - job6
    - job6
    - job6
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target aarch64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/aarch64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: '{aarch64-guest_test_uefi,aarch64-linux-musl-pipette,aarch64-linux-musl-tmk_vmm,aarch64-openhcl-igvm,aarch64-tmks,aarch64-windows-openvmm,aarch64-windows-pipette,aarch64-windows-tmk_vmm,aarch64-windows-vmm-tests-archive}'
        path: ${{ runner.temp }}/used_artifacts/
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 22 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 22 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 22 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-guest_test_uefi" | flowey.exe v 22 'artifact_use_from_aarch64-guest_test_uefi' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-linux-musl-pipette" | flowey.exe v 22 'artifact_use_from_aarch64-linux-musl-pipette' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-linux-musl-tmk_vmm" | flowey.exe v 22 'artifact_use_from_aarch64-linux-musl-tmk_vmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-openhcl-igvm" | flowey.exe v 22 'artifact_use_from_aarch64-openhcl-igvm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-tmks" | flowey.exe v 22 'artifact_use_from_aarch64-tmks' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-windows-openvmm" | flowey.exe v 22 'artifact_use_from_aarch64-windows-openvmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-windows-pipette" | flowey.exe v 22 'artifact_use_from_aarch64-windows-pipette' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-windows-tmk_vmm" | flowey.exe v 22 'artifact_use_from_aarch64-windows-tmk_vmm' --update-from-stdin --is-raw-string
        echo "${{ runner.temp }}\\used_artifacts\\aarch64-windows-vmm-tests-archive" | flowey.exe v 22 'artifact_use_from_aarch64-windows-vmm-tests-archive' --update-from-stdin --is-raw-string
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey.exe e 22 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 22 flowey_lib_common::cache 4
        flowey.exe v 22 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar7 --is-raw-string
        flowey.exe v 22 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar8 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar7 }}
        path: ${{ env.floweyvar8 }}
      name: 'Restore cache: cargo-nextest'
    - name: add default cargo home to path
      run: |-
        flowey.exe v 22 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey.exe e 22 flowey_lib_common::cache 6
        flowey.exe e 22 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey.exe e 22 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 22 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: flowey.exe e 22 flowey_lib_common::install_rust 2
      shell: bash
    - name: report $CARGO_HOME
      run: flowey.exe e 22 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: flowey.exe e 22 flowey_lib_common::download_cargo_nextest 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 22 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 22 flowey_lib_common::cache 8
        flowey.exe v 22 'flowey_lib_common::cache:18:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar9 --is-raw-string
        flowey.exe v 22 'flowey_lib_common::cache:17:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar10 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__9
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar9 }}
        path: ${{ env.floweyvar10 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 22 'flowey_lib_common::cache:20:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__9.outputs.cache-hit }}
        EOF
        flowey.exe e 22 flowey_lib_common::cache 10
        flowey.exe e 22 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack mu_msvm package (aarch64)
      run: flowey.exe e 22 flowey_lib_hvlite::download_uefi_mu_msvm 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 22 flowey_lib_common::git_checkout 0
        flowey.exe v 22 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar4 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 22 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar4 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 22 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 22 flowey_lib_common::git_checkout 3
        flowey.exe e 22 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey.exe e 22 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move MSVM.fd into its magic folder
      run: flowey.exe e 22 flowey_lib_hvlite::init_openvmm_magicpath_uefi_mu_msvm 0
      shell: bash
    - name: init hyperv tests
      run: |-
        flowey.exe e 22 flowey_lib_hvlite::init_hyperv_tests 0
        flowey.exe e 22 flowey_lib_hvlite::run_cargo_nextest_run 0
        flowey.exe e 22 flowey_core::pipeline::artifact::resolve 4
        flowey.exe e 22 flowey_core::pipeline::artifact::resolve 5
        flowey.exe e 22 flowey_core::pipeline::artifact::resolve 1
        flowey.exe e 22 flowey_core::pipeline::artifact::resolve 0
        flowey.exe e 22 flowey_core::pipeline::artifact::resolve 6
        flowey.exe e 22 flowey_core::pipeline::artifact::resolve 2
        flowey.exe e 22 flowey_core::pipeline::artifact::resolve 3
      shell: bash
    - name: creating new test content dir
      run: flowey.exe e 22 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 0
      shell: bash
    - name: resolve OpenHCL igvm artifact
      run: flowey.exe e 22 flowey_lib_hvlite::artifact_openhcl_igvm_from_recipe::resolve 0
      shell: bash
    - name: create azcopy cache dir
      run: flowey.exe e 22 flowey_lib_common::download_azcopy 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 22 flowey_lib_common::cache 0
        flowey.exe v 22 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar5 --is-raw-string
        flowey.exe v 22 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar6 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar5 }}
        path: ${{ env.floweyvar6 }}
      name: 'Restore cache: azcopy'
    - name: installing azcopy
      run: |-
        flowey.exe v 22 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 22 flowey_lib_common::cache 2
        flowey.exe e 22 flowey_lib_common::download_azcopy 1
      shell: bash
    - name: calculating required VMM tests disk images
      run: flowey.exe e 22 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 0
      shell: bash
    - name: downloading VMM test disk images
      run: |-
        flowey.exe e 22 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 1
        flowey.exe e 22 flowey_lib_hvlite::download_openvmm_vmm_tests_artifacts 2
      shell: bash
    - name: unpack openvmm-deps archive
      run: flowey.exe e 22 flowey_lib_hvlite::download_openvmm_deps 0
      shell: bash
    - name: setting up vmm_tests env
      run: |-
        flowey.exe e 22 flowey_lib_hvlite::init_vmm_tests_env 0
        flowey.exe e 22 flowey_lib_hvlite::run_cargo_nextest_run 1
        flowey.exe e 22 flowey_core::pipeline::artifact::resolve 7
        flowey.exe e 22 flowey_lib_hvlite::test_nextest_vmm_tests_archive 0
      shell: bash
    - name: run 'vmm_tests' nextest tests
      run: |-
        flowey.exe e 22 flowey_lib_common::run_cargo_nextest_run 0
        flowey.exe e 22 flowey_lib_common::run_cargo_nextest_run 1
        flowey.exe e 22 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 2
        flowey.exe e 22 flowey_lib_common::publish_test_results 4
        flowey.exe e 22 flowey_lib_common::publish_test_results 5
        flowey.exe v 22 'flowey_lib_common::publish_test_results:9:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar2 --is-raw-string --condvar flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey.exe v 22 'flowey_lib_common::publish_test_results:7:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__6
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-vmm-tests-crash-dumps
        path: ${{ env.floweyvar2 }}
      name: 'publish test results: crash-dumps (aarch64-windows-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey.exe e 22 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 1
        flowey.exe e 22 flowey_lib_common::publish_test_results 7
        flowey.exe e 22 flowey_lib_common::publish_test_results 8
        flowey.exe v 22 'flowey_lib_common::publish_test_results:14:flowey_lib_common/src/publish_test_results.rs:149:62' --write-to-gh-env floweyvar3 --is-raw-string --condvar flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57
        flowey.exe v 22 'flowey_lib_common::publish_test_results:12:flowey_lib_common/src/publish_test_results.rs:141:57' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__9
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-vmm-tests-logs
        path: ${{ env.floweyvar3 }}
      name: 'publish test results: logs (aarch64-windows-vmm-tests)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: ðŸ¦€ flowey rust steps
      run: |-
        flowey.exe e 22 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 3
        flowey.exe e 22 flowey_lib_common::publish_test_results 0
        flowey.exe e 22 flowey_lib_common::publish_test_results 1
        flowey.exe e 22 flowey_lib_common::publish_test_results 2
        flowey.exe v 22 'flowey_lib_common::publish_test_results:4:flowey_lib_common/src/publish_test_results.rs:95:47' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43
        flowey.exe v 22 'flowey_lib_common::publish_test_results:0:flowey_lib_common/src/publish_test_results.rs:77:43' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__publish_test_results__3
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-vmm-tests-junit-xml
        path: ${{ env.floweyvar1 }}
      name: 'publish test results: aarch64-windows-vmm-tests (JUnit XML)'
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report test results to overall pipeline status
      run: flowey.exe e 22 flowey_lib_hvlite::_jobs::consume_and_test_nextest_vmm_tests_archive 4
      shell: bash
    - name: 'validate cache entry: azcopy'
      run: flowey.exe e 22 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey.exe e 22 flowey_lib_common::cache 7
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 22 flowey_lib_common::cache 11
      shell: bash
  job23:
    name: test flowey local backend
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 23 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 23 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 23 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 23 flowey_lib_common::git_checkout 0
        flowey v 23 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 23 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 23 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 23 flowey_lib_common::git_checkout 3
        flowey e 23 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: add default cargo home to path
      run: flowey e 23 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: |-
        flowey e 23 flowey_lib_common::install_rust 1
        flowey v 23 'flowey_lib_hvlite::_jobs::test_local_flowey_build_igvm:2:flowey_core/src/node/github_context.rs:42:41' --is-secret --update-from-stdin --is-raw-string <<EOF
        ${{ github.token }}
        EOF
      shell: bash
    - name: test cargo xflowey build-igvm x64 --install-missing-deps
      run: flowey e 23 flowey_lib_hvlite::_jobs::test_local_flowey_build_igvm 1
      shell: bash
  job24:
    name: openvmm checkin gates
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    needs:
    - job23
    - job22
    - job21
    - job20
    - job19
    - job18
    - job17
    - job16
    - job15
    - job14
    - job13
    - job12
    - job11
    - job10
    - job9
    - job8
    - job7
    - job6
    - job5
    - job4
    - job3
    - job2
    - job1
    - job0
    if: always() && github.event.pull_request.draft == false
    env:
      ANY_JOBS_FAILED: ${{ contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'failure') }}
    steps:
    - name: ðŸŒ¼ðŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: _internal-flowey-bootstrap-x86_64-linux-uid-7
        path: ${{ runner.temp }}/used_artifacts/
    - run: echo "${{ runner.temp }}/used_artifacts/_internal-flowey-bootstrap-x86_64-linux-uid-7" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/used_artifacts/_internal-flowey-bootstrap-x86_64-linux-uid-7/flowey

        echo '"debug"' | flowey v 24 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 24 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 24 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: Check if any jobs failed
      run: flowey e 24 flowey_lib_hvlite::_jobs::all_good_job 0
      shell: bash
  job3:
    name: xtask fmt (windows)
    runs-on: windows-latest
    permissions:
      contents: read
      id-token: write
    needs:
    - job4
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 3 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 3 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 3 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 3 flowey_lib_common::git_checkout 0
        flowey.exe v 3 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 3 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 3 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 3 flowey_lib_common::git_checkout 3
        flowey.exe e 3 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: add default cargo home to path
      run: flowey.exe e 3 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 3 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey.exe e 3 flowey_lib_common::install_rust 2
        flowey.exe e 3 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey.exe e 3 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 3 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 3 flowey_lib_common::cache 0
        flowey.exe v 3 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey.exe v 3 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 3 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 3 flowey_lib_common::cache 2
        flowey.exe e 3 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack protoc
      run: |-
        flowey.exe e 3 flowey_lib_common::download_protoc 0
        flowey.exe e 3 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey.exe e 3 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey.exe e 3 flowey_lib_hvlite::init_cross_build 0
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey.exe e 3 flowey_lib_common::run_cargo_build 0
        flowey.exe e 3 flowey_lib_hvlite::run_cargo_build 0
        flowey.exe e 3 flowey_lib_hvlite::build_xtask 0
      shell: bash
    - name: run xtask fmt
      run: flowey.exe e 3 flowey_lib_hvlite::_jobs::check_xtask_fmt 0
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 3 flowey_lib_common::cache 3
      shell: bash
  job4:
    name: xtask fmt (linux)
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 4 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 4 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 4 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 4 flowey_lib_common::git_checkout 0
        flowey v 4 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 4 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 4 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 4 flowey_lib_common::git_checkout 3
        flowey e 4 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: add default cargo home to path
      run: flowey e 4 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 4 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 4 flowey_lib_common::install_rust 2
        flowey e 4 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 4 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 4 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 4 flowey_lib_common::cache 0
        flowey v 4 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey v 4 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 4 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 4 flowey_lib_common::cache 2
        flowey e 4 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 4 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 4 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: unpack protoc
      run: |-
        flowey e 4 flowey_lib_common::download_protoc 0
        flowey e 4 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey e 4 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey e 4 flowey_lib_hvlite::init_cross_build 0
      shell: bash
    - name: cargo build xtask
      run: |-
        flowey e 4 flowey_lib_common::run_cargo_build 0
        flowey e 4 flowey_lib_hvlite::run_cargo_build 0
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 4 flowey_lib_hvlite::run_split_debug_info 0
        flowey e 4 flowey_lib_hvlite::run_cargo_build 1
        flowey e 4 flowey_lib_hvlite::build_xtask 0
      shell: bash
    - name: run xtask fmt
      run: flowey e 4 flowey_lib_hvlite::_jobs::check_xtask_fmt 0
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 4 flowey_lib_common::cache 3
      shell: bash
  job5:
    name: build artifacts (not for VMM tests) [aarch64-windows]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Win-Pool-WestUS3
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 5 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 5 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 5 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-hypestv"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-hypestv" | flowey.exe v 5 'artifact_publish_from_aarch64-windows-hypestv' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-igvmfilegen"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-igvmfilegen" | flowey.exe v 5 'artifact_publish_from_aarch64-windows-igvmfilegen' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-ohcldiag-dev"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-ohcldiag-dev" | flowey.exe v 5 'artifact_publish_from_aarch64-windows-ohcldiag-dev' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-tmk_vmm"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-tmk_vmm" | flowey.exe v 5 'artifact_publish_from_aarch64-windows-tmk_vmm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-vmgs_lib"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-vmgs_lib" | flowey.exe v 5 'artifact_publish_from_aarch64-windows-vmgs_lib' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-vmgstool"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-vmgstool" | flowey.exe v 5 'artifact_publish_from_aarch64-windows-vmgstool' --update-from-stdin --is-raw-string
      shell: bash
    - name: add default cargo home to path
      run: flowey.exe e 5 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 5 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey.exe e 5 flowey_lib_common::install_rust 2
        flowey.exe e 5 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 5 flowey_lib_common::git_checkout 0
        flowey.exe v 5 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 5 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 5 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 5 flowey_lib_common::git_checkout 3
        flowey.exe e 5 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey.exe e 5 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 5 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 5 flowey_lib_common::cache 0
        flowey.exe v 5 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey.exe v 5 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 5 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 5 flowey_lib_common::cache 2
        flowey.exe e 5 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack protoc
      run: |-
        flowey.exe e 5 flowey_lib_common::download_protoc 0
        flowey.exe e 5 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey.exe e 5 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey.exe e 5 flowey_lib_hvlite::init_cross_build 5
      shell: bash
    - name: cargo build ohcldiag-dev
      run: |-
        flowey.exe e 5 flowey_lib_common::run_cargo_build 2
        flowey.exe e 5 flowey_lib_hvlite::run_cargo_build 2
        flowey.exe e 5 flowey_lib_hvlite::build_ohcldiag_dev 0
        flowey.exe e 5 flowey_core::pipeline::artifact::publish 4
        flowey.exe e 5 flowey_lib_hvlite::init_cross_build 0
      shell: bash
    - name: cargo build tmk_vmm
      run: |-
        flowey.exe e 5 flowey_lib_common::run_cargo_build 3
        flowey.exe e 5 flowey_lib_hvlite::run_cargo_build 3
        flowey.exe e 5 flowey_lib_hvlite::build_tmk_vmm 0
        flowey.exe e 5 flowey_core::pipeline::artifact::publish 5
        flowey.exe e 5 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build vmgstool
      run: |-
        flowey.exe e 5 flowey_lib_common::run_cargo_build 5
        flowey.exe e 5 flowey_lib_hvlite::run_cargo_build 5
        flowey.exe e 5 flowey_lib_hvlite::build_vmgstool 0
        flowey.exe e 5 flowey_core::pipeline::artifact::publish 0
        flowey.exe e 5 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build hypestv
      run: |-
        flowey.exe e 5 flowey_lib_common::run_cargo_build 0
        flowey.exe e 5 flowey_lib_hvlite::run_cargo_build 0
        flowey.exe e 5 flowey_lib_hvlite::build_hypestv 0
        flowey.exe e 5 flowey_core::pipeline::artifact::publish 1
        flowey.exe e 5 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build vmgs_lib
      run: |-
        flowey.exe e 5 flowey_lib_common::run_cargo_build 4
        flowey.exe e 5 flowey_lib_hvlite::run_cargo_build 4
        flowey.exe e 5 flowey_lib_hvlite::build_and_test_vmgs_lib 0
        flowey.exe e 5 flowey_lib_hvlite::build_and_test_vmgs_lib 1
        flowey.exe e 5 flowey_core::pipeline::artifact::publish 2
        flowey.exe e 5 flowey_lib_hvlite::init_cross_build 4
      shell: bash
    - name: cargo build igvmfilegen
      run: |-
        flowey.exe e 5 flowey_lib_common::run_cargo_build 1
        flowey.exe e 5 flowey_lib_hvlite::run_cargo_build 1
        flowey.exe e 5 flowey_lib_hvlite::build_igvmfilegen 0
        flowey.exe e 5 flowey_core::pipeline::artifact::publish 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 5 flowey_lib_common::cache 3
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-hypestv
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-hypestv
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-hypestv/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-igvmfilegen
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-igvmfilegen
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-igvmfilegen/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-ohcldiag-dev
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-ohcldiag-dev
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-ohcldiag-dev/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-tmk_vmm
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-tmk_vmm
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-tmk_vmm/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-vmgs_lib
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-vmgs_lib
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-vmgs_lib/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-vmgstool
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-vmgstool
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-vmgstool/
  job6:
    name: build artifacts (for VMM tests) [aarch64-windows]
    runs-on: windows-latest
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 6 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 6 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 6 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-openvmm"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-openvmm" | flowey.exe v 6 'artifact_publish_from_aarch64-windows-openvmm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-pipette"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-pipette" | flowey.exe v 6 'artifact_publish_from_aarch64-windows-pipette' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-windows-vmm-tests-archive"
        echo "${{ runner.temp }}\\publish_artifacts\\aarch64-windows-vmm-tests-archive" | flowey.exe v 6 'artifact_publish_from_aarch64-windows-vmm-tests-archive' --update-from-stdin --is-raw-string
      shell: bash
    - name: add default cargo home to path
      run: flowey.exe e 6 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 6 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey.exe e 6 flowey_lib_common::install_rust 2
        flowey.exe e 6 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 6 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 6 flowey_lib_common::cache 4
        flowey.exe v 6 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar4 --is-raw-string
        flowey.exe v 6 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar5 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar4 }}
        path: ${{ env.floweyvar5 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 6 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey.exe e 6 flowey_lib_common::cache 6
        flowey.exe e 6 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.AARCH64.zip
      run: flowey.exe e 6 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 6 flowey_lib_common::git_checkout 0
        flowey.exe v 6 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 6 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 6 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 6 flowey_lib_common::git_checkout 3
        flowey.exe e 6 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey.exe e 6 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey.exe e 6 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey.exe e 6 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: flowey.exe e 6 flowey_lib_common::download_protoc 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey.exe e 6 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey.exe e 6 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build openvmm
      run: |-
        flowey.exe e 6 flowey_lib_common::run_cargo_build 0
        flowey.exe e 6 flowey_lib_hvlite::run_cargo_build 0
        flowey.exe e 6 flowey_lib_hvlite::build_openvmm 0
        flowey.exe e 6 flowey_core::pipeline::artifact::publish 0
        flowey.exe e 6 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build pipette
      run: |-
        flowey.exe e 6 flowey_lib_common::run_cargo_build 1
        flowey.exe e 6 flowey_lib_hvlite::run_cargo_build 1
        flowey.exe e 6 flowey_lib_hvlite::build_pipette 0
        flowey.exe e 6 flowey_core::pipeline::artifact::publish 1
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey.exe e 6 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 6 flowey_lib_common::cache 0
        flowey.exe v 6 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey.exe v 6 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: cargo-nextest'
    - name: report $CARGO_HOME
      run: |-
        flowey.exe v 6 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 6 flowey_lib_common::cache 2
        flowey.exe e 6 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey.exe e 6 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: |-
        flowey.exe e 6 flowey_lib_common::download_cargo_nextest 1
        flowey.exe e 6 flowey_lib_hvlite::init_cross_build 0
      shell: bash
    - name: build + archive 'vmm_tests' nextests
      run: |-
        flowey.exe e 6 flowey_lib_common::run_cargo_nextest_archive 0
        flowey.exe e 6 flowey_lib_hvlite::build_nextest_vmm_tests 0
        flowey.exe e 6 flowey_core::pipeline::artifact::publish 2
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey.exe e 6 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 6 flowey_lib_common::cache 7
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-openvmm
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-openvmm
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-openvmm/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-pipette
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-pipette
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-pipette/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-windows-vmm-tests-archive
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-windows-vmm-tests-archive
        path: ${{ runner.temp }}/publish_artifacts/aarch64-windows-vmm-tests-archive/
  job7:
    name: build artifacts (not for VMM tests) [x64-windows]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Win-Pool-WestUS3
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 7 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 7 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 7 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-hypestv"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-hypestv" | flowey.exe v 7 'artifact_publish_from_x64-windows-hypestv' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-igvmfilegen"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-igvmfilegen" | flowey.exe v 7 'artifact_publish_from_x64-windows-igvmfilegen' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-ohcldiag-dev"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-ohcldiag-dev" | flowey.exe v 7 'artifact_publish_from_x64-windows-ohcldiag-dev' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-tmk_vmm"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-tmk_vmm" | flowey.exe v 7 'artifact_publish_from_x64-windows-tmk_vmm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-vmgs_lib"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-vmgs_lib" | flowey.exe v 7 'artifact_publish_from_x64-windows-vmgs_lib' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-vmgstool"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-vmgstool" | flowey.exe v 7 'artifact_publish_from_x64-windows-vmgstool' --update-from-stdin --is-raw-string
      shell: bash
    - name: add default cargo home to path
      run: flowey.exe e 7 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 7 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey.exe e 7 flowey_lib_common::install_rust 2
        flowey.exe e 7 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 7 flowey_lib_common::git_checkout 0
        flowey.exe v 7 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 7 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 7 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 7 flowey_lib_common::git_checkout 3
        flowey.exe e 7 flowey_lib_hvlite::git_checkout_openvmm_repo 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey.exe e 7 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 7 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 7 flowey_lib_common::cache 0
        flowey.exe v 7 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey.exe v 7 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 7 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 7 flowey_lib_common::cache 2
        flowey.exe e 7 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack protoc
      run: |-
        flowey.exe e 7 flowey_lib_common::download_protoc 0
        flowey.exe e 7 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey.exe e 7 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey.exe e 7 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build vmgstool
      run: |-
        flowey.exe e 7 flowey_lib_common::run_cargo_build 5
        flowey.exe e 7 flowey_lib_hvlite::run_cargo_build 5
        flowey.exe e 7 flowey_lib_hvlite::build_vmgstool 0
        flowey.exe e 7 flowey_core::pipeline::artifact::publish 5
        flowey.exe e 7 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build hypestv
      run: |-
        flowey.exe e 7 flowey_lib_common::run_cargo_build 0
        flowey.exe e 7 flowey_lib_hvlite::run_cargo_build 0
        flowey.exe e 7 flowey_lib_hvlite::build_hypestv 0
        flowey.exe e 7 flowey_core::pipeline::artifact::publish 0
        flowey.exe e 7 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build vmgs_lib
      run: |-
        flowey.exe e 7 flowey_lib_common::run_cargo_build 4
        flowey.exe e 7 flowey_lib_hvlite::run_cargo_build 4
        flowey.exe e 7 flowey_lib_hvlite::build_and_test_vmgs_lib 0
      shell: bash
    - name: test vmgs_lib
      run: |-
        flowey.exe e 7 flowey_lib_hvlite::build_and_test_vmgs_lib 1
        flowey.exe e 7 flowey_lib_hvlite::build_and_test_vmgs_lib 2
        flowey.exe e 7 flowey_core::pipeline::artifact::publish 1
        flowey.exe e 7 flowey_lib_hvlite::init_cross_build 4
      shell: bash
    - name: cargo build igvmfilegen
      run: |-
        flowey.exe e 7 flowey_lib_common::run_cargo_build 1
        flowey.exe e 7 flowey_lib_hvlite::run_cargo_build 1
        flowey.exe e 7 flowey_lib_hvlite::build_igvmfilegen 0
        flowey.exe e 7 flowey_core::pipeline::artifact::publish 2
        flowey.exe e 7 flowey_lib_hvlite::init_cross_build 5
      shell: bash
    - name: cargo build ohcldiag-dev
      run: |-
        flowey.exe e 7 flowey_lib_common::run_cargo_build 2
        flowey.exe e 7 flowey_lib_hvlite::run_cargo_build 2
        flowey.exe e 7 flowey_lib_hvlite::build_ohcldiag_dev 0
        flowey.exe e 7 flowey_core::pipeline::artifact::publish 3
        flowey.exe e 7 flowey_lib_hvlite::init_cross_build 0
      shell: bash
    - name: cargo build tmk_vmm
      run: |-
        flowey.exe e 7 flowey_lib_common::run_cargo_build 3
        flowey.exe e 7 flowey_lib_hvlite::run_cargo_build 3
        flowey.exe e 7 flowey_lib_hvlite::build_tmk_vmm 0
        flowey.exe e 7 flowey_core::pipeline::artifact::publish 4
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 7 flowey_lib_common::cache 3
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-hypestv
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-hypestv
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-hypestv/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-igvmfilegen
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-igvmfilegen
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-igvmfilegen/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-ohcldiag-dev
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-ohcldiag-dev
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-ohcldiag-dev/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-tmk_vmm
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-tmk_vmm
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-tmk_vmm/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-vmgs_lib
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-vmgs_lib
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-vmgs_lib/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-vmgstool
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-vmgstool
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-vmgstool/
  job8:
    name: build artifacts (for VMM tests) [x64-windows]
    runs-on: windows-latest
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-pc-windows-msvc --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-pc-windows-msvc/flowey-ci/flowey_hvlite.exe "$OutDirNormal/flowey.exe"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey.exe pipeline github --runtime $ESCAPED_AGENT_TEMPDIR\\bootstrapped-flowey\\pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey.exe

        echo '"debug"' | flowey.exe v 8 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey.exe v 8 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey.exe v 8 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-openvmm"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-openvmm" | flowey.exe v 8 'artifact_publish_from_x64-windows-openvmm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-pipette"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-pipette" | flowey.exe v 8 'artifact_publish_from_x64-windows-pipette' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/x64-windows-vmm-tests-archive"
        echo "${{ runner.temp }}\\publish_artifacts\\x64-windows-vmm-tests-archive" | flowey.exe v 8 'artifact_publish_from_x64-windows-vmm-tests-archive' --update-from-stdin --is-raw-string
      shell: bash
    - name: add default cargo home to path
      run: flowey.exe e 8 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey.exe e 8 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey.exe e 8 flowey_lib_common::install_rust 2
        flowey.exe e 8 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey.exe e 8 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 8 flowey_lib_common::cache 4
        flowey.exe v 8 'flowey_lib_common::cache:10:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar4 --is-raw-string
        flowey.exe v 8 'flowey_lib_common::cache:9:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar5 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__5
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar4 }}
        path: ${{ env.floweyvar5 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey.exe v 8 'flowey_lib_common::cache:12:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__5.outputs.cache-hit }}
        EOF
        flowey.exe e 8 flowey_lib_common::cache 6
        flowey.exe e 8 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.x64.zip
      run: flowey.exe e 8 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey.exe e 8 flowey_lib_common::git_checkout 0
        flowey.exe v 8 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey.exe v 8 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey.exe v 8 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey.exe e 8 flowey_lib_common::git_checkout 3
        flowey.exe e 8 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey.exe e 8 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey.exe e 8 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey.exe e 8 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: flowey.exe e 8 flowey_lib_common::download_protoc 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey.exe e 8 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey.exe e 8 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build openvmm
      run: |-
        flowey.exe e 8 flowey_lib_common::run_cargo_build 0
        flowey.exe e 8 flowey_lib_hvlite::run_cargo_build 0
        flowey.exe e 8 flowey_lib_hvlite::build_openvmm 0
        flowey.exe e 8 flowey_core::pipeline::artifact::publish 0
        flowey.exe e 8 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build pipette
      run: |-
        flowey.exe e 8 flowey_lib_common::run_cargo_build 1
        flowey.exe e 8 flowey_lib_hvlite::run_cargo_build 1
        flowey.exe e 8 flowey_lib_hvlite::build_pipette 0
        flowey.exe e 8 flowey_core::pipeline::artifact::publish 1
      shell: bash
    - name: create cargo-nextest cache dir
      run: flowey.exe e 8 flowey_lib_common::download_cargo_nextest 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey.exe e 8 flowey_lib_common::cache 0
        flowey.exe v 8 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey.exe v 8 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: cargo-nextest'
    - name: report $CARGO_HOME
      run: |-
        flowey.exe v 8 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey.exe e 8 flowey_lib_common::cache 2
        flowey.exe e 8 flowey_lib_common::cfg_persistent_dir_cargo_install 0
        flowey.exe e 8 flowey_lib_common::install_rust 3
      shell: bash
    - name: installing cargo-nextest
      run: |-
        flowey.exe e 8 flowey_lib_common::download_cargo_nextest 1
        flowey.exe e 8 flowey_lib_hvlite::init_cross_build 0
      shell: bash
    - name: build + archive 'vmm_tests' nextests
      run: |-
        flowey.exe e 8 flowey_lib_common::run_cargo_nextest_archive 0
        flowey.exe e 8 flowey_lib_hvlite::build_nextest_vmm_tests 0
        flowey.exe e 8 flowey_core::pipeline::artifact::publish 2
      shell: bash
    - name: 'validate cache entry: cargo-nextest'
      run: flowey.exe e 8 flowey_lib_common::cache 3
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey.exe e 8 flowey_lib_common::cache 7
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-openvmm
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-openvmm
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-openvmm/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-pipette
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-pipette
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-pipette/
    - name: ðŸŒ¼ðŸ“¦ Publish x64-windows-vmm-tests-archive
      uses: actions/upload-artifact@v4
      with:
        name: x64-windows-vmm-tests-archive
        path: ${{ runner.temp }}/publish_artifacts/x64-windows-vmm-tests-archive/
    - name: ðŸŒ¼ðŸ§¼ Redact bootstrap var db
      run: rm $AgentTempDirNormal/bootstrapped-flowey/job8.json
      shell: bash
    - name: ðŸŒ¼ðŸ¥¾ Publish bootstrapped flowey
      uses: actions/upload-artifact@v4
      with:
        name: _internal-flowey-bootstrap-x86_64-windows-uid-11
        path: ${{ runner.temp }}/bootstrapped-flowey
  job9:
    name: build artifacts [aarch64-linux]
    runs-on:
    - self-hosted
    - 1ES.Pool=OpenVMM-GitHub-Linux-Pool-WestUS3
    - 1ES.ImageOverride=MMSUbuntu22.04-256GB
    permissions:
      contents: read
      id-token: write
    if: github.event.pull_request.draft == false
    steps:
    - run: |
        set -x
        i=0; while [ $i -lt 5 ] && ! sudo apt-get update; do let "i=i+1"; sleep 1; done;
        sudo apt-get -o DPkg::Lock::Timeout=60 install gcc -y
        curl --fail --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain=1.86.0 -y
        . "$HOME/.cargo/env"
        echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
        rustup show
      if: runner.os == 'Linux'
      name: rustup (Linux)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/x86_64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'X64'
      name: rustup (Windows X64)
      shell: bash
    - run: |
        set -x
        curl --fail -sSfLo rustup-init.exe https://win.rustup.rs/aarch64 --output rustup-init
        ./rustup-init.exe -y --default-toolchain=1.86.0
        echo "$USERPROFILE\\.cargo\\bin" >> $GITHUB_PATH
      if: runner.os == 'Windows' && runner.arch == 'ARM64'
      name: rustup (Windows ARM64)
      shell: bash
    - uses: actions/checkout@v4
      with:
        path: flowey_bootstrap
    - name: Build flowey
      run: |
        set -x
        CARGO_INCREMENTAL=0 RUSTC_BOOTSTRAP=1 RUSTFLAGS="-Z threads=8" cargo build -p flowey_hvlite --target x86_64-unknown-linux-gnu --profile flowey-ci
        OutDirNormal=$(echo "${{ runner.temp }}/bootstrapped-flowey" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        mkdir -p "$OutDirNormal"
        mv ./.github/workflows/openvmm-pr.yaml "$OutDirNormal/pipeline.yaml"
        mv target/x86_64-unknown-linux-gnu/flowey-ci/flowey_hvlite "$OutDirNormal/flowey"
      working-directory: flowey_bootstrap
      shell: bash
    - run: echo "${{ runner.temp }}/bootstrapped-flowey" >> $GITHUB_PATH
      shell: bash
      name: ðŸŒ¼ðŸ“¦ Add flowey to PATH
    - name: ðŸŒ¼ðŸ”Ž Self-check YAML
      run: |-
        ESCAPED_AGENT_TEMPDIR=$(
        cat <<'EOF' | sed 's/\\/\\\\/g'
        ${{ runner.temp }}
        EOF
        )
        flowey pipeline github --runtime $ESCAPED_AGENT_TEMPDIR/bootstrapped-flowey/pipeline.yaml --out .github/workflows/openvmm-pr.yaml ci checkin-gates --config=pr
      shell: bash
    - name: ðŸŒ¼ðŸ›« Initialize job
      run: |
        AgentTempDirNormal="${{ runner.temp }}"
        AgentTempDirNormal=$(echo "$AgentTempDirNormal" | sed -e 's|\\|\/|g' -e 's|^\([A-Za-z]\)\:/\(.*\)|/\L\1\E/\2|')
        echo "AgentTempDirNormal=$AgentTempDirNormal" >> $GITHUB_ENV

        chmod +x $AgentTempDirNormal/bootstrapped-flowey/flowey

        echo '"debug"' | flowey v 9 'FLOWEY_LOG' --update-from-stdin
        echo "${{ runner.temp }}/work" | flowey v 9 '_internal_WORKING_DIR' --update-from-stdin --is-raw-string

        cat <<'EOF' | flowey v 9 'verbose' --update-from-stdin
        ${{ inputs.verbose != '' && inputs.verbose || 'false' }}
        EOF
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-guest_test_uefi"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-guest_test_uefi" | flowey v 9 'artifact_publish_from_aarch64-guest_test_uefi' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-linux-igvmfilegen"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-linux-igvmfilegen" | flowey v 9 'artifact_publish_from_aarch64-linux-igvmfilegen' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-linux-ohcldiag-dev"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-linux-ohcldiag-dev" | flowey v 9 'artifact_publish_from_aarch64-linux-ohcldiag-dev' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-linux-openvmm"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-linux-openvmm" | flowey v 9 'artifact_publish_from_aarch64-linux-openvmm' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-linux-vmgs_lib"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-linux-vmgs_lib" | flowey v 9 'artifact_publish_from_aarch64-linux-vmgs_lib' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-linux-vmgstool"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-linux-vmgstool" | flowey v 9 'artifact_publish_from_aarch64-linux-vmgstool' --update-from-stdin --is-raw-string
        mkdir -p "$AgentTempDirNormal/publish_artifacts/aarch64-tmks"
        echo "$AgentTempDirNormal/publish_artifacts/aarch64-tmks" | flowey v 9 'artifact_publish_from_aarch64-tmks' --update-from-stdin --is-raw-string
      shell: bash
    - name: add default cargo home to path
      run: flowey e 9 flowey_lib_common::install_rust 0
      shell: bash
    - name: install Rust
      run: flowey e 9 flowey_lib_common::install_rust 1
      shell: bash
    - name: detect active toolchain
      run: |-
        flowey e 9 flowey_lib_common::install_rust 2
        flowey e 9 flowey_lib_common::cfg_cargo_common_flags 0
      shell: bash
    - name: checking if packages need to be installed
      run: flowey e 9 flowey_lib_common::install_dist_pkg 0
      shell: bash
    - name: installing packages
      run: flowey e 9 flowey_lib_common::install_dist_pkg 1
      shell: bash
    - name: create gh-release-download cache dir
      run: flowey e 9 flowey_lib_common::download_gh_release 0
      shell: bash
    - name: Pre-processing cache vars
      run: |-
        flowey e 9 flowey_lib_common::cache 0
        flowey v 9 'flowey_lib_common::cache:2:flowey_lib_common/src/cache.rs:457:72' --write-to-gh-env floweyvar2 --is-raw-string
        flowey v 9 'flowey_lib_common::cache:1:flowey_lib_common/src/cache.rs:456:72' --write-to-gh-env floweyvar3 --is-raw-string
      shell: bash
    - id: flowey_lib_common__cache__1
      uses: actions/cache@v4
      with:
        key: ${{ env.floweyvar2 }}
        path: ${{ env.floweyvar3 }}
      name: 'Restore cache: gh-release-download'
    - name: download artifacts from github releases
      run: |-
        flowey v 9 'flowey_lib_common::cache:4:flowey_lib_common/src/cache.rs:514:46' --update-from-stdin --is-raw-string <<EOF
        ${{ steps.flowey_lib_common__cache__1.outputs.cache-hit }}
        EOF
        flowey e 9 flowey_lib_common::cache 2
        flowey e 9 flowey_lib_common::download_gh_release 1
      shell: bash
    - name: unpack Microsoft.WSL.LxUtil.AARCH64.zip
      run: flowey e 9 flowey_lib_hvlite::download_lxutil 0
      shell: bash
    - name: check if openvmm needs to be cloned
      run: |-
        flowey e 9 flowey_lib_common::git_checkout 0
        flowey v 9 'flowey_lib_common::git_checkout:0:flowey_lib_common/src/git_checkout.rs:469:80' --write-to-gh-env floweyvar1 --is-raw-string --condvar flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46
        flowey v 9 'flowey_lib_common::git_checkout:1:flowey_lib_common/src/git_checkout.rs:470:46' --write-to-gh-env FLOWEY_CONDITION
      shell: bash
    - id: flowey_lib_common__git_checkout__1
      uses: actions/checkout@v4
      with:
        fetch-depth: '1'
        path: repo0
        persist-credentials: ${{ env.floweyvar1 }}
      name: checkout repo openvmm
      if: ${{ fromJSON(env.FLOWEY_CONDITION) }}
    - name: report cloned repo directories
      run: |-
        flowey v 9 'flowey_lib_common::git_checkout:4:flowey_core/src/node/github_context.rs:42:41' --update-from-stdin --is-raw-string <<EOF
        ${{ github.workspace }}
        EOF
        flowey e 9 flowey_lib_common::git_checkout 3
        flowey e 9 flowey_lib_hvlite::git_checkout_openvmm_repo 0
        flowey e 9 flowey_lib_hvlite::cfg_openvmm_magicpath 0
      shell: bash
    - name: move lxutil.dll into its magic folder
      run: flowey e 9 flowey_lib_hvlite::init_openvmm_magicpath_lxutil 0
      shell: bash
    - name: set '-Dwarnings' in .cargo/config.toml
      run: flowey e 9 flowey_lib_hvlite::init_openvmm_cargo_config_deny_warnings 0
      shell: bash
    - name: unpack protoc
      run: flowey e 9 flowey_lib_common::download_protoc 0
      shell: bash
    - name: symlink protoc
      run: |-
        flowey e 9 flowey_lib_hvlite::init_openvmm_magicpath_protoc 0
        flowey e 9 flowey_lib_hvlite::init_cross_build 2
      shell: bash
    - name: cargo build openvmm
      run: |-
        flowey e 9 flowey_lib_common::run_cargo_build 3
        flowey e 9 flowey_lib_hvlite::run_cargo_build 5
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 9 flowey_lib_hvlite::run_split_debug_info 1
        flowey e 9 flowey_lib_hvlite::run_cargo_build 6
        flowey e 9 flowey_lib_hvlite::build_openvmm 0
        flowey e 9 flowey_core::pipeline::artifact::publish 0
        flowey e 9 flowey_lib_hvlite::init_cross_build 4
      shell: bash
    - name: cargo build vmgstool
      run: |-
        flowey e 9 flowey_lib_common::run_cargo_build 6
        flowey e 9 flowey_lib_hvlite::run_cargo_build 12
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 9 flowey_lib_hvlite::run_split_debug_info 3
        flowey e 9 flowey_lib_hvlite::run_cargo_build 13
        flowey e 9 flowey_lib_hvlite::build_vmgstool 0
        flowey e 9 flowey_core::pipeline::artifact::publish 1
        flowey e 9 flowey_lib_hvlite::init_cross_build 3
      shell: bash
    - name: cargo build vmgs_lib
      run: |-
        flowey e 9 flowey_lib_common::run_cargo_build 5
        flowey e 9 flowey_lib_hvlite::run_cargo_build 11
        flowey e 9 flowey_lib_hvlite::build_and_test_vmgs_lib 0
        flowey e 9 flowey_lib_hvlite::build_and_test_vmgs_lib 1
        flowey e 9 flowey_core::pipeline::artifact::publish 2
        flowey e 9 flowey_lib_hvlite::init_cross_build 5
      shell: bash
    - name: cargo build igvmfilegen
      run: |-
        flowey e 9 flowey_lib_common::run_cargo_build 1
        flowey e 9 flowey_lib_hvlite::run_cargo_build 1
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 9 flowey_lib_hvlite::run_split_debug_info 4
        flowey e 9 flowey_lib_hvlite::run_cargo_build 2
        flowey e 9 flowey_lib_hvlite::build_igvmfilegen 0
        flowey e 9 flowey_core::pipeline::artifact::publish 3
        flowey e 9 flowey_lib_hvlite::init_cross_build 1
      shell: bash
    - name: cargo build ohcldiag-dev
      run: |-
        flowey e 9 flowey_lib_common::run_cargo_build 2
        flowey e 9 flowey_lib_hvlite::run_cargo_build 3
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 9 flowey_lib_hvlite::run_split_debug_info 0
        flowey e 9 flowey_lib_hvlite::run_cargo_build 4
        flowey e 9 flowey_lib_hvlite::build_ohcldiag_dev 0
        flowey e 9 flowey_core::pipeline::artifact::publish 4
        flowey e 9 flowey_lib_hvlite::init_cross_build 6
      shell: bash
    - name: cargo build guest_test_uefi
      run: |-
        flowey e 9 flowey_lib_common::run_cargo_build 0
        flowey e 9 flowey_lib_hvlite::run_cargo_build 0
      shell: bash
    - name: build guest_test_uefi.img
      run: |-
        flowey e 9 flowey_lib_hvlite::build_guest_test_uefi 0
        flowey e 9 flowey_core::pipeline::artifact::publish 5
        flowey e 9 flowey_lib_hvlite::init_cross_build 0
        flowey e 9 flowey_lib_hvlite::run_cargo_build 7
        flowey e 9 flowey_lib_hvlite::run_cargo_build 8
      shell: bash
    - name: cargo build simple_tmk
      run: |-
        flowey e 9 flowey_lib_common::run_cargo_build 4
        flowey e 9 flowey_lib_hvlite::run_cargo_build 9
      shell: bash
    - name: split debug symbols
      run: |-
        flowey e 9 flowey_lib_hvlite::run_split_debug_info 2
        flowey e 9 flowey_lib_hvlite::run_cargo_build 10
        flowey e 9 flowey_lib_hvlite::build_tmks 0
        flowey e 9 flowey_core::pipeline::artifact::publish 6
      shell: bash
    - name: 'validate cache entry: gh-release-download'
      run: flowey e 9 flowey_lib_common::cache 3
      shell: bash
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-guest_test_uefi
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-guest_test_uefi
        path: ${{ runner.temp }}/publish_artifacts/aarch64-guest_test_uefi/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-linux-igvmfilegen
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-linux-igvmfilegen
        path: ${{ runner.temp }}/publish_artifacts/aarch64-linux-igvmfilegen/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-linux-ohcldiag-dev
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-linux-ohcldiag-dev
        path: ${{ runner.temp }}/publish_artifacts/aarch64-linux-ohcldiag-dev/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-linux-openvmm
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-linux-openvmm
        path: ${{ runner.temp }}/publish_artifacts/aarch64-linux-openvmm/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-linux-vmgs_lib
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-linux-vmgs_lib
        path: ${{ runner.temp }}/publish_artifacts/aarch64-linux-vmgs_lib/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-linux-vmgstool
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-linux-vmgstool
        path: ${{ runner.temp }}/publish_artifacts/aarch64-linux-vmgstool/
    - name: ðŸŒ¼ðŸ“¦ Publish aarch64-tmks
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-tmks
        path: ${{ runner.temp }}/publish_artifacts/aarch64-tmks/
